<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Central Women's University - Class Attendance Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; color: #334155; }
        .container { max-width: 1200px; }
        .card { background-color: #fff; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05); }
        .btn-primary { background-color: #dc2626; color: #fff; border-radius: .5rem; padding: .75rem 1.5rem; transition: background-color .3s ease; }
        .btn-primary:hover { background-color: #b91c1c; }
        .btn-secondary { background-color: #6b7280; color: #fff; border-radius: .5rem; padding: .75rem 1.5rem; transition: background-color .3s ease; }
        .btn-secondary:hover { background-color: #4b5563; }
        input[type="text"], input[type="date"], input[type="time"], input[type="number"], input[type="email"], input[type="password"], select, textarea { border-radius: .5rem; border: 1px solid #d1d5db; padding: .75rem 1rem; width: 100%; transition: border-color .3s ease, box-shadow .3s ease; }
        input[type="text"]:focus, input[type="date"]:focus, input[type="time"]:focus, input[type="number"]:focus, input[type="email"]:focus, input[type="password"]:focus, select:focus, textarea:focus { border-color: #dc2626; box-shadow: 0 0 0 3px rgba(220,38,38,.2); outline: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: .75rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { background-color: #fee2e2; font-weight: 600; color: #991b1b; }
        tr:hover { background-color: #fef2f2; }
        .nav-menu-item { position: relative; }
        .nav-menu-button { cursor: pointer; padding: .75rem 1.5rem; border-radius: .5rem; transition: background-color .3s ease, color .3s ease; white-space: nowrap; font-weight: 500; color: #334155; }
        .nav-menu-button:hover { background-color: #fee2e2; color: #dc2626; }
        .nav-menu-button.active { background-color: #dc2626; color: #fff; }
        .submenu { display: none; position: absolute; top: 100%; left: 0; background-color: #fff; border-radius: .5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,.1), 0 2px 4px -1px rgba(0,0,0,.06); min-width: 180px; z-index: 100; padding: .5rem 0; }
        .submenu.active { display: block; }
        .submenu-item { padding: .75rem 1.5rem; cursor: pointer; white-space: nowrap; transition: background-color .3s ease, color .3s ease; color: #334155; }
        .submenu-item:hover { background-color: #fee2e2; color: #dc2626; }
        .submenu-item.active { background-color: #fef2f2; color: #dc2626; font-weight: 600; }
        .message-box { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #fff; padding: 2rem; border-radius: 1rem; box-shadow: 0 10px 20px rgba(0,0,0,.2); z-index: 1000; text-align: center; display: none; }
        .message-box-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,.5); z-index: 999; display: none; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,.6); display: flex; justify-content: center; align-items: center; z-index: 1000; overflow-y: auto; }
        .modal-content { background-color: #fff; padding: 2rem; border-radius: 1rem; box-shadow: 0 10px 20px rgba(0,0,0,.2); width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .draggable-course { cursor: grab; background-color: #fef2f2; border: 1px solid #dc2626; padding: .5rem; margin-bottom: .5rem; border-radius: .5rem; font-size: .875rem; font-weight: 500; color: #991b1b; transition: transform .1s ease-in-out, box-shadow .1s ease-in-out; }
        .draggable-course:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,.1), 0 2px 4px -1px rgba(0,0,0,.06); }
        .draggable-course.dragging { opacity: .5; cursor: grabbing; }
        .routine-grid-container { overflow-x: auto; border: 1px solid #e5e7eb; border-radius: .5rem; }
        .routine-grid { min-width: 800px; border-collapse: collapse; }
        .routine-grid th, .routine-grid td { border: 1px solid #e5e7eb; padding: .5rem; text-align: center; vertical-align: top; height: 60px; }
        .routine-grid th { background-color: #fee2e2; font-weight: 600; color: #991b1b; position: sticky; top: 0; z-index: 10; }
        .routine-grid td { background-color: #fff; }
        .routine-grid td.time-slot-header { background-color: #fef2f2; font-weight: 500; color: #dc2626; position: sticky; left: 0; z-index: 10; }
        .drop-target.drag-over { background-color: #fce7f3; border: 2px dashed #db2777; }
        .routine-item { background-color: #ef4444; color: #fff; border-radius: .5rem; padding: .25rem .5rem; font-size: .75rem; font-weight: 600; margin-bottom: .25rem; display: flex; justify-content: space-between; align-items: center; }
        .routine-item .delete-btn { background: none; border: none; color: #fff; cursor: pointer; font-size: 1rem; line-height: 1; padding: 0 .25rem; }
        .routine-item .delete-btn:hover { color: #fca5a5; }
        .clash-report { background-color: #fef2f2; border: 1px solid #ef4444; border-radius: .5rem; padding: 1rem; margin-top: 1.5rem; }
        .clash-report h3 { color: #dc2626; margin-bottom: .75rem; }
        .clash-report ul { list-style: disc; padding-left: 1.25rem; }
        .clash-report li { margin-bottom: .5rem; color: #b91c1c; }
        .clash-report li.solution { color: #16a34a; font-weight: 500; }
        .tab-buttons { display: flex; margin-bottom: 1.5rem; border-bottom: 2px solid #e5e7eb; }
        .tab-button { padding: .75rem 1.5rem; cursor: pointer; font-weight: 600; color: #6b7280; border-bottom: 2px solid transparent; transition: all .3s ease; }
        .tab-button:hover { color: #dc2626; }
        .tab-button.active { color: #dc2626; border-bottom-color: #dc2626; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .expandable-item { cursor: pointer; padding: .75rem 1rem; border-bottom: 1px solid #e5e7eb; background-color: #fef2f2; font-weight: 600; color: #dc2626; display: flex; justify-content: space-between; align-items: center; transition: background-color .2s ease; }
        .expandable-item:hover { background-color: #fee2e2; }
        .expandable-content { display: none; padding: 1rem; background-color: #fff; border: 1px solid #e5e7eb; border-top: none; margin-bottom: .5rem; }
        .expandable-content.active { display: block; }
        .expandable-item .arrow { transition: transform .2s ease; }
        .expandable-item.active .arrow { transform: rotate(90deg); }

        @media print {
            body { font-family: 'Times New Roman', serif !important; background-color: #fff; color: #000; margin: 0; padding: 0; font-size: 10pt; }
            .container, #mainContent { box-shadow: none !important; border: none !important; padding: 0 !important; margin: 0 !important; width: 100% !important; max-width: none !important; }
            .content-section { padding: 15mm !important; margin-bottom: 10mm; page-break-after: always; }
            .content-section:last-child { page-break-after: auto; }
            .print-header, .print-footer { display: none !important; }
            #loginSection, .nav-menu-item, .tab-buttons, form, .btn-primary, .btn-secondary, .message-box, .message-box-overlay, #loadingIndicator, .clash-report, .delete-btn, .actions-cell { display: none !important; }
            table { border: 1px solid #000; width: 100%; font-size: 9pt; }
            th, td { border: 1px solid #000; padding: 5px; text-align: left; background-color: #fff !important; color: #000 !important; }
            th { font-weight: bold; }
            tr:nth-child(even) { background-color: #f9f9f9 !important; }
            #dragDropRoutineGrid { min-width: unset; width: 100%; }
            .routine-grid-container { overflow-x: visible; border: none; }
            .routine-grid th, .routine-grid td { height: auto; vertical-align: middle; }
            .routine-item { background-color: #e0e0e0 !important; color: #000 !important; border: 1px solid #ccc !important; box-shadow: none !important; margin-bottom: 2px; padding: 2px 5px; font-size: 8pt; }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="loginSection" class="flex items-center justify-center min-h-screen bg-gray-100">
        <div class="card p-8 w-full max-w-md">
            <h2 class="text-3xl font-bold text-center text-red-700 mb-6">Login</h2>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="username" class="block text-gray-700 text-sm font-bold mb-2">Username:</label>
                    <input type="text" id="username" name="username" required class="focus:ring-red-500 focus:border-red-500">
                </div>
                <div>
                    <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Password:</label>
                    <input type="password" id="password" name="password" required class="focus:ring-red-500 focus:border-red-500">
                </div>
                <div class="flex items-center mb-4">
                    <input type="checkbox" id="keepLoggedIn" class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded">
                    <label for="keepLoggedIn" class="ml-2 text-gray-700 text-sm">Keep me logged in</label>
                </div>
                <button type="submit" class="btn-primary w-full">Login</button>
                <p id="loginError" class="text-red-500 text-center text-sm mt-2 hidden">Invalid username or password.</p>
                <p class="text-sm text-center mt-4">User ID: <span id="displayUserId" class="font-semibold text-gray-600">Not logged in</span></p>
            </form>
        </div>
    </div>

    <div id="mainContent" class="container mx-auto bg-white rounded-2xl shadow-xl p-6 md:p-10 hidden">
        <h1 class="text-4xl font-extrabold text-center text-red-800 mb-2">Central Women's University</h1>
        <h2 class="text-2xl font-bold text-center text-red-600 mb-8">Department of English Language and Literature</h2>
        
        <nav class="mb-8 flex flex-wrap justify-center gap-2">
            <div class="nav-menu-item">
                <button class="nav-menu-button active" id="navHomeButton">Home</button>
            </div>
            <div class="nav-menu-item">
                <button class="nav-menu-button" data-target="academicManagementSubmenu">Academic Management</button>
                <div id="academicManagementSubmenu" class="submenu">
                    <div id="navCurricula" class="submenu-item" data-section="curriculaSection">Curricula</div>
                    <div id="navStudents" class="submenu-item" data-section="studentsViewSection">Students</div>
                    <div id="navFaculty" class="submenu-item" data-section="facultyViewSection">Faculty</div>
                    <div id="navCourseOfferings" class="submenu-item" data-section="courseOfferingsViewSection">Course Offerings</div>
                </div>
            </div>
            <div class="nav-menu-item">
                <button class="nav-menu-button" data-target="classCalendarSubmenu">Class & Calendar</button>
                <div id="classCalendarSubmenu" class="submenu">
                    <div id="navRoutine" class="submenu-item" data-section="routineViewSection">Routine</div>
                    <div id="navAttendance" class="submenu-item" data-section="attendanceSection">Attendance Sheet</div>
                    <div id="navHolidays" class="submenu-item" data-section="holidaysEventsViewSection">Holidays & Events</div>
                    <div id="navAcademicCalendar" class="submenu-item" data-section="academicCalendarViewSection">Academic Calendar</div>
                </div>
            </div>
            <div class="nav-menu-item">
                <button class="nav-menu-button" data-target="myToolsSubmenu">Tools</button>
                <div id="myToolsSubmenu" class="submenu">
                    <div id="navAddRemove" class="submenu-item" data-section="addRemoveSection">Add/Remove Data</div>
                    <div id="navDragDropRoutine" class="submenu-item" data-section="dragDropRoutineSection">Routine Maker</div>
                    <div id="navCourseOutline" class="submenu-item" data-section="courseOutlineGeneratorSection">Course Outline Generator</div>
                </div>
            </div>
            <div class="nav-menu-item">
                <button class="nav-menu-button" id="logoutButton">Logout</button>
            </div>
        </nav>

        <div id="messageBoxOverlay" class="message-box-overlay"></div>
        <div id="messageBox" class="message-box">
            <p id="messageBoxText" class="text-lg mb-4"></p>
            <button id="messageBoxClose" class="btn-primary">OK</button>
        </div>

        <div id="loadingIndicator" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-[1001]">
            <div class="bg-white p-6 rounded-lg shadow-lg flex items-center space-x-3">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-red-500"></div>
                <p class="text-lg text-gray-700">Loading data...</p>
            </div>
        </div>

        <section id="homeSection" class="content-section">
            <h2 class="text-3xl font-bold text-red-700 mb-6">Home</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card p-6">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-4">Today's Events & Agendas</h3>
                    <div id="eventsAgendasList" class="space-y-2">
                        <p class="text-gray-500">No events scheduled for today.</p>
                    </div>
                </div>
                <div class="card p-6">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-4">Upcoming Events</h3>
                    <div id="upcomingEventsList" class="space-y-2">
                        <p class="text-gray-500">No upcoming events.</p>
                    </div>
                </div>
            </div>
             <p class="text-sm text-center mt-8">User ID: <span id="mainDisplayUserId" class="font-semibold text-gray-600">Not logged in</span></p>
        </section>

        <section id="addRemoveSection" class="content-section hidden">
            <h2 class="text-3xl font-bold text-red-700 mb-6">Add/Remove Data</h2>
            <div class="card p-6">
                <div class="tab-buttons">
                    <button class="tab-button active" data-tab="coursesOfferingsTab">Courses & Offerings</button>
                    <button class="tab-button" data-tab="peopleTab">People (Students & Faculty)</button>
                    <button class="tab-button" data-tab="calendarEventsTab">Calendar Events (Routine, Holidays, Agendas)</button>
                </div>

                <div id="coursesOfferingsTab" class="tab-content active">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-4" id="courseFormTitle">Add New Course to Curriculum</h3>
                    <form id="addCourseForm" class="space-y-4 mb-8">
                        <input type="hidden" id="courseId" name="courseId">
                        <div>
                            <label for="courseName" class="block text-gray-700 text-sm font-bold mb-2">Course Name:</label>
                            <input type="text" id="courseName" name="courseName" required class="focus:ring-red-500 focus:border-red-500">
                        </div>
                        <div>
                            <label for="courseCode" class="block text-gray-700 text-sm font-bold mb-2">Course Code:</label>
                            <input type="text" id="courseCode" name="courseCode" required class="focus:ring-red-500 focus:border-red-500">
                        </div>
                        <div>
                            <label for="courseCredit" class="block text-gray-700 text-sm font-bold mb-2">Credit:</label>
                            <input type="number" id="courseCredit" name="courseCredit" step="0.5" min="0" required class="focus:ring-red-500 focus:border-red-500">
                        </div>
                        <div>
                            <label for="courseSemester" class="block text-gray-700 text-sm font-bold mb-2">Default Semester (e.g., Spring 2025):</label>
                            <input type="text" id="courseSemester" name="courseSemester" placeholder="e.g., Spring 2025" required class="focus:ring-red-500 focus:border-red-500">
                        </div>
                        <div>
                            <label for="courseFaculty" class="block text-gray-700 text-sm font-bold mb-2">Default Faculty (Teacher):</label>
                            <select id="courseFaculty" name="courseFaculty" class="focus:ring-red-500 focus:border-red-500" required>
                                <option value="">-- Select Faculty --</option>
                            </select>
                        </div>
                        <div>
                            <label for="courseType" class="block text-gray-700 text-sm font-bold mb-2">Course Type:</label>
                            <select id="courseType" name="courseType" class="focus:ring-red-500 focus:border-red-500" required>
                                <option value="">-- Select Type --</option>
                                <option value="Core Course">Core Course</option>
                                <option value="GED">GED</option>
                                <option value="Elective">Elective</option>
                                <option value="Thesis">Thesis</option>
                                <option value="Optional General Education">Optional General Education</option>
                            </select>
                        </div>
                        <div>
                            <label for="curriculumType" class="block text-gray-700 text-sm font-bold mb-2">Curriculum Type:</label>
                            <select id="curriculumType" name="curriculumType" class="focus:ring-red-500 focus:border-red-500" required>
                                <option value="">-- Select Curriculum --</option>
                                <option value="BA (Non-OBE)">BA (Non-OBE)</option>
                                <option value="BA (OBE)">BA (OBE)</option>
                                <option value="MA (Non-OBE)">MA (Non-OBE)</option>
                                <option value="MA (OBE)">MA (OBE)</option>
                                <option value="TESOL (OBE)">TESOL (OBE)</option>
                            </select>
                        </div>
                        <div>
                            <label for="offeredToSemester" class="block text-gray-700 text-sm font-bold mb-2">Offered to (Target Semester for Curriculum):</label>
                            <select id="offeredToSemester" name="offeredToSemester" class="focus:ring-red-500 focus:border-red-500" required>
                                <option value="">-- Select Semester --</option>
                                <option value="1st Semester">1st Semester</option>
                                <option value="2nd Semester">2nd Semester</option>
                                <option value="3rd Semester">3rd Semester</option>
                                <option value="4th Semester">4th Semester</option>
                                <option value="5th Semester">5th Semester</option>
                                <option value="6th Semester">6th Semester</option>
                                <option value="7th Semester">7th Semester</option>
                                <option value="8th Semester">8th Semester</option>
                                <option value="Foundation Semester">Foundation Semester</option>
                                <option value="Flexible">Flexible</option>
                                <option value="Final Semester">Final Semester</option>
                            </select>
                        </div>
                        <div>
                            <label for="courseTiming" class="block text-gray-700 text-sm font-bold mb-2">Default Class Timing (e.g., Mon/Wed 10:00-11:30 AM):</label>
                            <input type="text" id="courseTiming" name="courseTiming" required class="focus:ring-red-500 focus:border-red-500">
                        </div>
                        <div>
                            <label for="courseRoom" class="block text-gray-700 text-sm font-bold mb-2">Default Room Number:</label>
                            <input type="text" id="courseRoom" name="courseRoom" required class="focus:ring-red-500 focus:border-red-500">
                        </div>
                        <button type="submit" id="addUpdateCourseBtn" class="btn-primary w-full">Add Course to Curriculum</button>
                        <button type="button" id="cancelCourseEditBtn" class="btn-secondary w-full hidden">Cancel Edit</button>
                    </form>
                    <h3 class="text-2xl font-semibold text-gray-800 mb-4">Existing Courses (in Curriculum)</h3>
                    <div id="coursesList" class="overflow-x-auto mb-8">
                        <p class="text-gray-500 text-center">No courses added yet.</p>
                    </div>
                     <div class="flex flex-wrap gap-2 mt-6">
                        <button onclick="printContent('coursesList', 'Courses List')" class="btn-secondary">Print Courses</button>
                        <button onclick="downloadContentAsPdf('coursesList', 'Courses_List.pdf')" class="btn-primary">Download PDF</button>
                    </div>
                    <hr class="my-8">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-4" id="courseOfferingFormTitle">Add Course Offering for Semester</h3>
                    <form id="addCourseOfferingForm" class="space-y-4 mb-8">
                        <input type="hidden" id="courseOfferingId" name="courseOfferingId">
                        <div>
                            <label for="offeringSemester" class="block text-gray-700 text-sm font-bold mb-2">Semester for Offering (e.g., Spring 2025):</label>
                            <input type="text" id="offeringSemester" name="offeringSemester" placeholder="e.g., Spring 2025" required class="focus:ring-red-500 focus:border-red-500">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">Select Courses from Curriculum for this Offering:</label>
                            <div id="availableCoursesForOffering" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 max-h-60 overflow-y-auto border p-4 rounded-md">
                                <p class="text-gray-500">No courses available. Add courses to curriculum first.</p>
                            </div>
                        </div>
                        <button type="submit" id="addUpdateOfferingBtn" class="btn-primary w-full">Add Course Offering</button>
                        <button type="button" id="cancelOfferingEditBtn" class="btn-secondary w-full hidden">Cancel Edit</button>
                    </form>
                    <h3 class="text-2xl font-semibold text-gray-800 mb-4">Existing Course Offerings</h3>
                    <div id="courseOfferingsList" class="overflow-x-auto">
                        <p class="text-gray-500 text-center">No course offerings added yet.</p>
                    </div>
                    <div class="flex flex-wrap gap-2 mt-6">
                        <button onclick="printContent('courseOfferingsList', 'Course Offerings List')" class="btn-secondary">Print Course Offerings</button>
                        <button onclick="downloadContentAsPdf('courseOfferingsList', 'Course_Offerings_List.pdf')" class="btn-primary">Download PDF</button>
                    </div>
                </div>

                <div id="peopleTab" class="tab-content">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-4" id="studentFormTitle">Add New Student</h3>
                    <form id="addStudentForm" class="space-y-4 mb-8">
                        <input type="hidden" id="studentDbId" name="studentDbId">
                        <div>
                            <label for="studentName" class="block text-gray-700 text-sm font-bold mb-2">Student Name:</label>
                            <input type="text" id="studentName" name="studentName" required class="focus:ring-red-500 focus:border-red-500">
                        </div>
                        <div>
                            <label for="studentId" class="block text-gray-700 text-sm font-bold mb-2">Student ID:</label>
                            <input type="text" id="studentId" name="studentId" required class="focus:ring-red-500 focus:border-red-500">
                        </div>
                        <div>
                            <label for="studentAddress" class="block text-gray-700 text-sm font-bold mb-2">Address:</label>
                            <textarea id="studentAddress" name="studentAddress" rows="3" required class="focus:ring-red-500 focus:border-red-500"></textarea>
                        </div>
                        <button type="submit" id="addUpdateStudentBtn" class="btn-primary w-full">Add Student</button>
                        <button type="button" id="cancelStudentEditBtn" class="btn-secondary w-full hidden">Cancel Edit</button>
                    </form>
                    <h3 class="text-2xl font-semibold text-gray-800 mb-4">Registered Students</h3>
                    <div id="studentsList" class="overflow-x-auto mb-8">
                        <p class="text-gray-500 text-center">No students added yet.</p>
                    </div>
                     <div class="flex flex-wrap gap-2 mt-6">
                        <button onclick="printContent('studentsList', 'Students List')" class="btn-secondary">Print Students</button>
                        <button onclick="downloadContentAsPdf('studentsList', 'Students_List.pdf')" class="btn-primary">Download PDF</button>
                    </div>
                    <hr class="my-8">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-4" id="teacherFormTitle">Add New Faculty</h3>
                    <form id="addTeacherForm" class="space-y-4 mb-8">
                        <input type="hidden" id="teacherDbId" name="teacherDbId">
                        <div>
                            <label for="teacherName" class="block text-gray-700 text-sm font-bold mb-2">Faculty Name:</label>
                            <input type="text" id="teacherName" name="teacherName" required class="focus:ring-red-500 focus:border-red-500">
                        </div>
                        <div>
                            <label for="teacherInitials" class="block text-gray-700 text-sm font-bold mb-2">Initials:</label>
                            <input type="text" id="teacherInitials" name="teacherInitials" required class="focus:ring-red-500 focus:border-red-500">
                        </div>
                        <div>
                            <label for="teacherType" class="block text-gray-700 text-sm font-bold mb-2">Faculty Type:</label>
                            <select id="teacherType" name="teacherType" class="focus:ring-red-500 focus:border-red-500" required>
                                <option value="">-- Select Type --</option>
                                <option value="Regular">Regular</option>
                                <option value="Adjunct">Adjunct</option>
                            </select>
                        </div>
                        <button type="submit" id="addUpdateTeacherBtn" class="btn-primary w-full">Add Faculty</button>
                        <button type="button" id="cancelTeacherEditBtn" class="btn-secondary w-full hidden">Cancel Edit</button>
                    </form>
                    <h3 class="text-2xl font-semibold text-gray-800 mb-4">Existing Faculty</h3>
                    <div id="teachersList" class="overflow-x-auto">
                        <p class="text-gray-500 text-center">No faculty added yet.</p>
                    </div>
                     <div class="flex flex-wrap gap-2 mt-6">
                        <button onclick="printContent('teachersList', 'Faculty List')" class="btn-secondary">Print Faculty</button>
                        <button onclick="downloadContentAsPdf('teachersList', 'Faculty_List.pdf')" class="btn-primary">Download PDF</button>
                    </div>
                </div>

                <div id="calendarEventsTab" class="tab-content">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-4" id="routineFormTitle">Add Routine Entry</h3>
                    <form id="addRoutineForm" class="space-y-4 mb-8">
                        <input type="hidden" id="routineId" name="routineId">
                        <div>
                            <label for="routineCourse" class="block text-gray-700 text-sm font-bold mb-2">Course:</label>
                            <select id="routineCourse" name="routineCourse" class="focus:ring-red-500 focus:border-red-500" required>
                                <option value="">-- Select Course --</option>
                                </select>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="routineDay" class="block text-gray-700 text-sm font-bold mb-2">Day:</label>
                                <select id="routineDay" name="routineDay" class="focus:ring-red-500 focus:border-red-500" required>
                                    <option value="">-- Select Day --</option>
                                    <option value="Sunday">Sunday</option>
                                    <option value="Monday">Monday</option>
                                    <option value="Tuesday">Tuesday</option>
                                    <option value="Wednesday">Wednesday</option>
                                    <option value="Thursday">Thursday</option>
                                    <option value="Friday">Friday</option>
                                    <option value="Saturday">Saturday</option>
                                </select>
                            </div>
                            <div>
                                <label for="routineStartTime" class="block text-gray-700 text-sm font-bold mb-2">Start Time:</label>
                                <input type="time" id="routineStartTime" name="routineStartTime" required class="focus:ring-red-500 focus:border-red-500">
                            </div>
                            <div>
                                <label for="routineEndTime" class="block text-gray-700 text-sm font-bold mb-2">End Time:</label>
                                <input type="time" id="routineEndTime" name="routineEndTime" required class="focus:ring-red-500 focus:border-red-500">
                            </div>
                        </div>
                        <div>
                            <label for="routineRoom" class="block text-gray-700 text-sm font-bold mb-2">Room Number:</label>
                            <input type="text" id="routineRoom" name="routineRoom" required class="focus:ring-red-500 focus:border-red-500">
                        </div>
                        <button type="submit" id="addUpdateRoutineBtn" class="btn-primary w-full">Add Routine Entry</button>
                        <button type="button" id="cancelRoutineEditBtn" class="btn-secondary w-full hidden">Cancel Edit</button>
                    </form>
                    <h3 class="text-2xl font-semibold text-gray-800 mb-4">Current Routine Entries</h3>
                    <div id="routineList" class="overflow-x-auto mb-8">
                        <p class="text-gray-500 text-center">No routine entries added yet.</p>
                    </div>
                    <div class="flex flex-wrap gap-2 mt-6">
                        <button onclick="printContent('routineList', 'Routine List')" class="btn-secondary">Print Routine</button>
                        <button onclick="downloadContentAsPdf('routineList', 'Routine_List.pdf')" class="btn-primary">Download PDF</button>
                    </div>
                    <hr class="my-8">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-4" id="eventFormTitle">Add New Event/Holiday/Agenda</h3>
                    <form id="addEventForm" class="space-y-4 mb-8">
                        <input type="hidden" id="eventId" name="eventId">
                        <div>
                            <label for="eventType" class="block text-gray-700 text-sm font-bold mb-2">Event Type:</label>
                            <select id="eventType" name="eventType" class="focus:ring-red-500 focus:border-red-500" required>
                                <option value="">-- Select Type --</option>
                                <option value="National Holiday">National Holiday</option>
                                <option value="University Closure">University Closure</option>
                                <option value="Departmental Event">Departmental Event</option>
                                <option value="Meeting/Agenda">Meeting/Agenda</option>
                                <option value="Teacher Absence">Teacher Absence</option>
                                <option value="Sick Leave">Sick Leave</option>
                                <option value="Make-up Class">Make-up Class</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label for="eventName" class="block text-gray-700 text-sm font-bold mb-2">Event Name/Description:</label>
                            <input type="text" id="eventName" name="eventName" required class="focus:ring-red-500 focus:border-red-500">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="eventStartDate" class="block text-gray-700 text-sm font-bold mb-2">Start Date:</label>
                                <input type="date" id="eventStartDate" name="eventStartDate" required class="focus:ring-red-500 focus:border-red-500">
                            </div>
                            <div>
                                <label for="eventEndDate" class="block text-gray-700 text-sm font-bold mb-2">End Date (Optional):</label>
                                <input type="date" id="eventEndDate" name="eventEndDate" class="focus:ring-red-500 focus:border-red-500">
                            </div>
                        </div>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="eventStartTime" class="block text-gray-700 text-sm font-bold mb-2">Start Time (Optional):</label>
                                <input type="time" id="eventStartTime" name="eventStartTime" class="focus:ring-red-500 focus:border-red-500">
                            </div>
                            <div>
                                <label for="eventEndTime" class="block text-gray-700 text-sm font-bold mb-2">End Time (Optional):</label>
                                <input type="time" id="eventEndTime" name="eventEndTime" class="focus:ring-red-500 focus:border-red-500">
                            </div>
                        </div>
                        <div id="eventAffectedFacultyContainer" class="hidden">
                            <label for="eventAffectedFaculty" class="block text-gray-700 text-sm font-bold mb-2">Affected Faculty (for Absence/Leave):</label>
                            <select id="eventAffectedFaculty" name="eventAffectedFaculty" class="focus:ring-red-500 focus:border-red-500">
                                <option value="">-- Select Faculty --</option>
                                </select>
                        </div>
                         <div id="eventAffectedCourseContainer" class="hidden">
                            <label for="eventAffectedCourse" class="block text-gray-700 text-sm font-bold mb-2">Affected Course (for Make-up):</label>
                            <select id="eventAffectedCourse" name="eventAffectedCourse" class="focus:ring-red-500 focus:border-red-500">
                                <option value="">-- Select Course --</option>
                                </select>
                        </div>
                        <button type="submit" id="addUpdateEventBtn" class="btn-primary w-full">Add Event</button>
                        <button type="button" id="cancelEventEditBtn" class="btn-secondary w-full hidden">Cancel Edit</button>
                    </form>
                    <h3 class="text-2xl font-semibold text-gray-800 mb-4">Existing Events, Holidays & Agendas</h3>
                    <div id="eventsList" class="overflow-x-auto">
                        <p class="text-gray-500 text-center">No events added yet.</p>
                    </div>
                     <div class="flex flex-wrap gap-2 mt-6">
                        <button onclick="printContent('eventsList', 'Events List')" class="btn-secondary">Print Events</button>
                        <button onclick="downloadContentAsPdf('eventsList', 'Events_List.pdf')" class="btn-primary">Download PDF</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="curriculaSection" class="content-section hidden">
             <h2 class="text-3xl font-bold text-red-700 mb-6">Curricula Overview</h2>
             <div id="curriculaDisplay" class="card p-6">
                <p class="text-gray-500">Curriculum details will be displayed here.</p>
             </div>
        </section>
        <section id="studentsViewSection" class="content-section hidden">
             <h2 class="text-3xl font-bold text-red-700 mb-6">Student Information</h2>
             <div id="studentsDisplay" class="card p-6">
                <p class="text-gray-500">Student list and details will be displayed here.</p>
             </div>
        </section>
        <section id="facultyViewSection" class="content-section hidden">
             <h2 class="text-3xl font-bold text-red-700 mb-6">Faculty Information</h2>
             <div id="facultyDisplay" class="card p-6">
                <p class="text-gray-500">Faculty list and details will be displayed here.</p>
             </div>
        </section>
        <section id="courseOfferingsViewSection" class="content-section hidden">
             <h2 class="text-3xl font-bold text-red-700 mb-6">Course Offerings by Semester</h2>
             <div id="courseOfferingsDisplay" class="card p-6">
                <p class="text-gray-500">Course offerings will be displayed here.</p>
             </div>
        </section>
        <section id="routineViewSection" class="content-section hidden">
            <h2 class="text-3xl font-bold text-red-700 mb-6">Class Routine</h2>
            <div class="card p-6">
                <div class="mb-4">
                    <label for="routineViewSemesterFilter" class="block text-sm font-medium text-gray-700">Filter by Semester (Offering):</label>
                    <select id="routineViewSemesterFilter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm rounded-md">
                        <option value="">All Semesters</option>
                        </select>
                </div>
                <div id="routineFullDisplay" class="routine-grid-container">
                    <p class="text-gray-500 text-center">Routine will be displayed here. Select a semester or use the Routine Maker tool.</p>
                </div>
                <div class="flex flex-wrap gap-2 mt-6">
                    <button onclick="printContent('routineFullDisplay', 'Class Routine')" class="btn-secondary">Print Routine</button>
                    <button onclick="downloadContentAsPdf('routineFullDisplay', 'Class_Routine.pdf')" class="btn-primary">Download PDF</button>
                </div>
            </div>
        </section>
        <section id="attendanceSection" class="content-section hidden">
            <h2 class="text-3xl font-bold text-red-700 mb-6">Attendance Sheet</h2>
             <div class="card p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label for="attendanceCourse" class="block text-sm font-medium text-gray-700">Select Course:</label>
                        <select id="attendanceCourse" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm rounded-md">
                            <option value="">-- Select Course --</option>
                            </select>
                    </div>
                    <div>
                        <label for="attendanceDate" class="block text-sm font-medium text-gray-700">Select Date:</label>
                        <input type="date" id="attendanceDate" name="attendanceDate" class="mt-1 focus:ring-red-500 focus:border-red-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                    </div>
                    <div class="flex items-end">
                         <button id="generateAttendanceSheetBtn" class="btn-primary w-full">Generate Sheet</button>
                    </div>
                </div>
                <div id="attendanceSheetDisplay" class="overflow-x-auto">
                    <p class="text-gray-500 text-center">Select a course and date to generate an attendance sheet.</p>
                </div>
                <div id="attendanceActionButtons" class="flex-wrap gap-2 mt-6 hidden">
                    <button onclick="printContent('attendanceSheetDisplay', 'Attendance Sheet')" class="btn-secondary">Print Sheet</button>
                    <button onclick="downloadContentAsPdf('attendanceSheetDisplay', 'Attendance_Sheet.pdf')" class="btn-primary">Download PDF</button>
                </div>
            </div>
        </section>
        <section id="holidaysEventsViewSection" class="content-section hidden">
             <h2 class="text-3xl font-bold text-red-700 mb-6">Holidays & Events Calendar</h2>
             <div id="holidaysEventsDisplay" class="card p-6">
                <p class="text-gray-500">List of holidays and events will be displayed here.</p>
             </div>
        </section>
        <section id="academicCalendarViewSection" class="content-section hidden">
             <h2 class="text-3xl font-bold text-red-700 mb-6">Academic Calendar</h2>
             <div id="academicCalendarDisplay" class="card p-6">
                <p class="text-gray-500">The academic calendar will be displayed here.</p>
             </div>
        </section>

        <section id="dragDropRoutineSection" class="content-section hidden">
            <h2 class="text-3xl font-bold text-red-700 mb-6">Drag & Drop Routine Maker</h2>
            <div class="card p-6">
                <div class="flex flex-col md:flex-row gap-6">
                    <div class="w-full md:w-1/3">
                        <h3 class="text-xl font-semibold text-gray-700 mb-3">Available Courses for Routine</h3>
                         <div class="mb-4">
                            <label for="routineMakerSemesterFilter" class="block text-sm font-medium text-gray-700">Filter by Semester (Offering):</label>
                            <select id="routineMakerSemesterFilter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm rounded-md">
                                <option value="">All Offered Courses</option>
                                </select>
                        </div>
                        <div id="draggableCoursesPool" class="space-y-2 p-3 bg-gray-50 rounded-lg border min-h-[200px] max-h-[400px] overflow-y-auto">
                            <p class="text-gray-400 text-sm">Select a semester to see offered courses. Drag courses to the grid.</p>
                        </div>
                    </div>
                    <div class="w-full md:w-2/3">
                        <h3 class="text-xl font-semibold text-gray-700 mb-3">Class Routine Grid</h3>
                        <div id="dragDropRoutineGridContainer" class="routine-grid-container">
                            <table id="dragDropRoutineGrid" class="routine-grid">
                                </table>
                        </div>
                         <div id="clashReportContainer" class="clash-report mt-4 hidden">
                            <h3 class="text-lg font-semibold">Clash Report</h3>
                            <ul id="clashReportList"></ul>
                        </div>
                        <div class="mt-6 flex flex-wrap gap-2">
                            <button id="saveRoutineBtn" class="btn-primary">Save Routine</button>
                            <button id="clearRoutineBtn" class="btn-secondary">Clear Grid</button>
                            <button onclick="printContent('dragDropRoutineGridContainer', 'Class Routine (Maker)')" class="btn-secondary">Print Grid</button>
                            <button onclick="downloadContentAsPdf('dragDropRoutineGridContainer', 'Class_Routine_Maker.pdf')" class="btn-primary">Download PDF</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <section id="courseOutlineGeneratorSection" class="content-section hidden">
            <h2 class="text-3xl font-bold text-red-700 mb-6">Course Outline Generator</h2>
            <div class="card p-6">
                <div class="space-y-4">
                    <div>
                        <label for="outlineCourseSelect" class="block text-sm font-medium text-gray-700">Select Course:</label>
                        <select id="outlineCourseSelect" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm rounded-md">
                            <option value="">-- Select Course --</option>
                            </select>
                    </div>
                    <div>
                        <label for="customPrompt" class="block text-sm font-medium text-gray-700">Additional Instructions/Topics (Optional):</label>
                        <textarea id="customPrompt" name="customPrompt" rows="3" class="mt-1 focus:ring-red-500 focus:border-red-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" placeholder="e.g., Focus on post-colonial literature, include a mid-term project..."></textarea>
                    </div>
                    <button id="generateOutlineBtn" class="btn-primary w-full md:w-auto">Generate Course Outline</button>
                </div>
                <div id="courseOutlineResult" class="mt-6 p-4 border rounded-md bg-gray-50 hidden min-h-[200px]">
                    <h3 class="text-xl font-semibold text-gray-700 mb-3">Generated Course Outline:</h3>
                    <div id="outlineContent" class="prose max-w-none">
                        </div>
                </div>
                 <div id="outlineActionButtons" class="flex-wrap gap-2 mt-6 hidden">
                    <button onclick="printContent('outlineContent', 'Course Outline')" class="btn-secondary">Print Outline</button>
                    <button onclick="downloadContentAsPdf('outlineContent', 'Course_Outline.pdf')" class="btn-primary">Download PDF</button>
                </div>
            </div>
        </section>


    </div> <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut as firebaseSignOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";


        // --- Firebase Configuration and Initialization ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "YOUR_API_KEY", // Replace with your actual config
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('debug'); // Or 'silent' for production

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-cwu-app';
        let currentUserId = null;
        let dbPrefix = ''; // Will be set after auth

        // --- Global Variables & DOM Elements ---
        const loginSection = document.getElementById('loginSection');
        const mainContent = document.getElementById('mainContent');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const logoutButton = document.getElementById('logoutButton');
        const displayUserId = document.getElementById('displayUserId');
        const mainDisplayUserId = document.getElementById('mainDisplayUserId');

        const loadingIndicator = document.getElementById('loadingIndicator');
        const messageBox = document.getElementById('messageBox');
        const messageBoxOverlay = document.getElementById('messageBoxOverlay');
        const messageBoxText = document.getElementById('messageBoxText');
        const messageBoxClose = document.getElementById('messageBoxClose');

        // --- Utility Functions ---
        function showLoading(show = true) {
            loadingIndicator.classList.toggle('hidden', !show);
        }

        function showMessage(text, isError = false) {
            messageBoxText.textContent = text;
            messageBox.classList.remove('bg-red-100', 'text-red-700', 'border-red-500');
            if (isError) {
                messageBox.classList.add('bg-red-100', 'text-red-700', 'border-red-500'); // Example error styling
            }
            messageBox.style.display = 'block';
            messageBoxOverlay.style.display = 'block';
        }

        messageBoxClose.addEventListener('click', () => {
            messageBox.style.display = 'none';
            messageBoxOverlay.style.display = 'none';
        });
        
        // --- Authentication ---
        onAuthStateChanged(auth, async (user) => {
            showLoading(true);
            if (user) {
                currentUserId = user.uid;
                dbPrefix = `/artifacts/${appId}/users/${currentUserId}`; // Private data path
                // dbPrefixPublic = `/artifacts/${appId}/public/data`; // Public data path if needed
                
                displayUserId.textContent = currentUserId;
                mainDisplayUserId.textContent = currentUserId;
                loginSection.classList.add('hidden');
                mainContent.classList.remove('hidden');
                console.log("User is signed in:", currentUserId);
                await loadInitialData(); // Load data after user is authenticated
                setActiveSection('homeSection'); // Show home section by default
            } else {
                currentUserId = null;
                dbPrefix = '';
                displayUserId.textContent = 'Not logged in';
                mainDisplayUserId.textContent = 'Not logged in';
                loginSection.classList.remove('hidden');
                mainContent.classList.add('hidden');
                console.log("User is signed out.");
            }
            showLoading(false);
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading(true);
            loginError.classList.add('hidden');
            // This is a placeholder for actual login. For Firebase, you'd use signInWithEmailAndPassword or other providers.
            // For now, we'll simulate a successful login and use anonymous or custom token sign-in.
            try {
                // Using custom token if available (from Canvas environment)
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                     await signInWithCustomToken(auth, __initial_auth_token);
                     console.log("Signed in with custom token.");
                } else {
                    // Fallback to anonymous sign-in if no custom token.
                    // In a real app, you'd have username/password auth here.
                    // For this demo, let's assume the username/password are just for show and proceed with anonymous.
                    const userCredential = await signInAnonymously(auth);
                    console.log("Signed in anonymously for demo purposes.", userCredential.user.uid);
                }
                 // If login is successful, onAuthStateChanged will handle showing main content.
            } catch (error) {
                console.error("Login failed:", error);
                loginError.textContent = `Login failed: ${error.message}. For demo, any input works if no custom token.`;
                loginError.classList.remove('hidden');
                showLoading(false);
            }
            // No need to hide loading here, onAuthStateChanged will do it.
        });

        logoutButton.addEventListener('click', async () => {
            showLoading(true);
            try {
                await firebaseSignOut(auth);
                // onAuthStateChanged will handle UI changes
            } catch (error) {
                console.error("Sign out error:", error);
                showMessage(`Sign out error: ${error.message}`, true);
                showLoading(false);
            }
        });


        // --- Navigation and Section Handling ---
        const contentSections = document.querySelectorAll('.content-section');
        const navMenuButtons = document.querySelectorAll('.nav-menu-button');
        const submenuItems = document.querySelectorAll('.submenu-item');

        function setActiveSection(sectionId) {
            showLoading(true);
            contentSections.forEach(section => {
                section.classList.toggle('hidden', section.id !== sectionId);
            });

            navMenuButtons.forEach(button => {
                button.classList.toggle('active', button.id === `nav${sectionId.replace('Section','')}Button` || (button.dataset.target && document.getElementById(button.dataset.target)?.querySelector(`[data-section="${sectionId}"]`)));
            });
            submenuItems.forEach(item => {
                item.classList.toggle('active', item.dataset.section === sectionId);
            });

            // Close all submenus
            document.querySelectorAll('.submenu.active').forEach(submenu => {
                 if (!submenu.querySelector(`.submenu-item[data-section="${sectionId}"]`)) {
                    submenu.classList.remove('active');
                 }
            });
            // Re-activate parent of active submenu item
            const activeSubmenuItem = document.querySelector(`.submenu-item[data-section="${sectionId}"]`);
            if (activeSubmenuItem) {
                const parentSubmenu = activeSubmenuItem.closest('.submenu');
                if (parentSubmenu) {
                    parentSubmenu.classList.add('active');
                    const parentButton = document.querySelector(`[data-target="${parentSubmenu.id}"]`);
                    if (parentButton) parentButton.classList.add('active');
                }
            }


            // Special loading/refresh for certain sections
            if (sectionId === 'homeSection') loadHomeData();
            if (sectionId === 'curriculaSection') loadAndDisplayCurricula();
            if (sectionId === 'studentsViewSection') loadAndDisplayStudentsForView();
            if (sectionId === 'facultyViewSection') loadAndDisplayFacultyForView();
            if (sectionId === 'courseOfferingsViewSection') loadAndDisplayCourseOfferingsForView();
            if (sectionId === 'routineViewSection') loadAndDisplayFullRoutine();
            if (sectionId === 'holidaysEventsViewSection') loadAndDisplayHolidaysEvents();
            if (sectionId === 'academicCalendarViewSection') loadAndDisplayAcademicCalendar();
            if (sectionId === 'dragDropRoutineSection') initializeRoutineMaker();


            setTimeout(() => showLoading(false), 200); // Give a slight delay for content to render
            console.log(`Active section set to: ${sectionId}`);
        }


        navMenuButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetSubmenuId = button.dataset.target;
                if (targetSubmenuId) {
                    // Toggle submenu
                    const submenu = document.getElementById(targetSubmenuId);
                    const isActive = submenu.classList.contains('active');
                    // Close other submenus
                    document.querySelectorAll('.submenu.active').forEach(sm => sm.classList.remove('active'));
                    navMenuButtons.forEach(btn => btn.classList.remove('active')); // Deactivate other main buttons

                    if (!isActive) {
                        submenu.classList.add('active');
                        button.classList.add('active'); // Activate this main button
                    } else {
                         button.classList.remove('active'); // Deactivate if closing
                    }
                } else if (button.id === 'navHomeButton') {
                    setActiveSection('homeSection');
                     navMenuButtons.forEach(btn => btn.classList.remove('active'));
                     button.classList.add('active');
                } else if (button.id === 'logoutButton') {
                    // Logout handled by its own listener
                }
            });
        });

        submenuItems.forEach(item => {
            item.addEventListener('click', () => {
                const sectionId = item.dataset.section;
                if (sectionId) {
                    setActiveSection(sectionId);
                    // Keep parent submenu active
                    const parentSubmenu = item.closest('.submenu');
                    if (parentSubmenu) {
                         document.querySelector(`[data-target="${parentSubmenu.id}"]`).classList.add('active');
                    }
                }
            });
        });
        
        // Close submenus when clicking outside
        document.addEventListener('click', (event) => {
            if (!event.target.closest('.nav-menu-item')) {
                document.querySelectorAll('.submenu.active').forEach(submenu => submenu.classList.remove('active'));
                // Optionally, also deactivate the main nav buttons if no submenu item was clicked
                // This part might need refinement based on desired UX
                 navMenuButtons.forEach(button => {
                    if (button.dataset.target && !document.getElementById(button.dataset.target).querySelector('.submenu-item.active')) {
                        // button.classList.remove('active'); // This line might be too aggressive, test UX
                    }
                 });
            }
        });


        // Tab switching logic for Add/Remove section
        const tabButtons = document.querySelectorAll('#addRemoveSection .tab-button');
        const tabContents = document.querySelectorAll('#addRemoveSection .tab-content');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                const targetTab = button.dataset.tab;
                tabContents.forEach(content => {
                    content.classList.toggle('active', content.id === targetTab);
                });
            });
        });

        // --- Firestore CRUD Operations ---
        // Generic add function
        async function addData(collectionName, data) {
            if (!currentUserId) { showMessage("User not authenticated.", true); return null; }
            showLoading(true);
            try {
                const docRef = await addDoc(collection(db, `${dbPrefix}/${collectionName}`), { ...data, createdAt: serverTimestamp(), owner: currentUserId });
                showMessage(`${collectionName.slice(0, -1)} added successfully!`, false);
                return docRef.id;
            } catch (error) {
                console.error(`Error adding ${collectionName}: `, error);
                showMessage(`Error adding ${collectionName}: ${error.message}`, true);
                return null;
            } finally {
                showLoading(false);
            }
        }

        // Generic update function
        async function updateData(collectionName, docId, data) {
            if (!currentUserId) { showMessage("User not authenticated.", true); return; }
            showLoading(true);
            try {
                const docRef = doc(db, `${dbPrefix}/${collectionName}`, docId);
                await updateDoc(docRef, { ...data, updatedAt: serverTimestamp() });
                showMessage(`${collectionName.slice(0, -1)} updated successfully!`, false);
            } catch (error) {
                console.error(`Error updating ${collectionName}: `, error);
                showMessage(`Error updating ${collectionName}: ${error.message}`, true);
            } finally {
                showLoading(false);
            }
        }

        // Generic delete function
        async function deleteData(collectionName, docId) {
            if (!currentUserId) { showMessage("User not authenticated.", true); return; }
            if (!confirm(`Are you sure you want to delete this ${collectionName.slice(0, -1)}? This action cannot be undone.`)) return;
            showLoading(true);
            try {
                await deleteDoc(doc(db, `${dbPrefix}/${collectionName}`, docId));
                showMessage(`${collectionName.slice(0, -1)} deleted successfully!`, false);
            } catch (error) {
                console.error(`Error deleting ${collectionName}: `, error);
                showMessage(`Error deleting ${collectionName}: ${error.message}`, true);
            } finally {
                showLoading(false);
            }
        }
        
        // Generic fetch function (real-time with onSnapshot)
        function fetchData(collectionName, callback) {
            if (!currentUserId) { console.log("User not authenticated, cannot fetch data."); return () => {}; }
            const q = query(collection(db, `${dbPrefix}/${collectionName}`)); //, orderBy("createdAt", "desc")
            const unsubscribe = onSnapshot(q, (querySnapshot) => {
                const items = [];
                querySnapshot.forEach((doc) => {
                    items.push({ id: doc.id, ...doc.data() });
                });
                callback(items);
            }, (error) => {
                console.error(`Error fetching ${collectionName}: `, error);
                showMessage(`Error fetching ${collectionName}: ${error.message}`, true);
                callback([]); // send empty array on error
            });
            return unsubscribe; // Return unsubscribe function for cleanup
        }
        
        // Store unsubscribe functions for cleanup on logout or re-auth
        let unsubscribers = [];
        function clearSubscribers() {
            unsubscribers.forEach(unsub => unsub());
            unsubscribers = [];
        }


        // --- Courses (Curriculum) ---
        const addCourseForm = document.getElementById('addCourseForm');
        const coursesListDiv = document.getElementById('coursesList');
        const courseFormTitle = document.getElementById('courseFormTitle');
        const addUpdateCourseBtn = document.getElementById('addUpdateCourseBtn');
        const cancelCourseEditBtn = document.getElementById('cancelCourseEditBtn');
        let editingCourseId = null;

        addCourseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const courseData = {
                name: addCourseForm.courseName.value,
                code: addCourseForm.courseCode.value,
                credit: parseFloat(addCourseForm.courseCredit.value),
                defaultSemester: addCourseForm.courseSemester.value,
                defaultFacultyId: addCourseForm.courseFaculty.value, // Store ID
                courseType: addCourseForm.courseType.value,
                curriculumType: addCourseForm.curriculumType.value,
                offeredToSemester: addCourseForm.offeredToSemester.value,
                defaultTiming: addCourseForm.courseTiming.value,
                defaultRoom: addCourseForm.courseRoom.value,
            };
            if (editingCourseId) {
                await updateData('courses', editingCourseId, courseData);
            } else {
                await addData('courses', courseData);
            }
            resetCourseForm();
            loadCourses(); // Refresh list
        });

        cancelCourseEditBtn.addEventListener('click', resetCourseForm);

        function resetCourseForm() {
            addCourseForm.reset();
            editingCourseId = null;
            courseFormTitle.textContent = "Add New Course to Curriculum";
            addUpdateCourseBtn.textContent = "Add Course to Curriculum";
            cancelCourseEditBtn.classList.add('hidden');
            addCourseForm.courseId.value = '';
        }

        function editCourse(course) {
            editingCourseId = course.id;
            addCourseForm.courseId.value = course.id;
            addCourseForm.courseName.value = course.name;
            addCourseForm.courseCode.value = course.code;
            addCourseForm.courseCredit.value = course.credit;
            addCourseForm.courseSemester.value = course.defaultSemester;
            addCourseForm.courseFaculty.value = course.defaultFacultyId;
            addCourseForm.courseType.value = course.courseType;
            addCourseForm.curriculumType.value = course.curriculumType;
            addCourseForm.offeredToSemester.value = course.offeredToSemester;
            addCourseForm.courseTiming.value = course.defaultTiming;
            addCourseForm.courseRoom.value = course.defaultRoom;

            courseFormTitle.textContent = "Edit Course in Curriculum";
            addUpdateCourseBtn.textContent = "Update Course";
            cancelCourseEditBtn.classList.remove('hidden');
            window.scrollTo({ top: addCourseForm.offsetTop - 20, behavior: 'smooth' });
        }

        async function deleteCourse(courseId) {
            await deleteData('courses', courseId);
            loadCourses(); // Refresh list
        }

        function renderCourses(courses) {
            if (courses.length === 0) {
                coursesListDiv.innerHTML = '<p class="text-gray-500 text-center">No courses added yet.</p>';
                return;
            }
            // Sort courses by code or name if needed
            courses.sort((a,b) => (a.code || "").localeCompare(b.code || "") || (a.name || "").localeCompare(b.name || ""));


            let tableHTML = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Code</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Credit</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Curriculum</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider actions-cell">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">`;
            
            courses.forEach(course => {
                tableHTML += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${course.code}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${course.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${course.credit}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${course.curriculumType} (${course.offeredToSemester})</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${course.courseType}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium actions-cell">
                            <button onclick="window.app.editCourse('${course.id}')" class="text-indigo-600 hover:text-indigo-900 mr-2">Edit</button>
                            <button onclick="window.app.deleteCourse('${course.id}')" class="text-red-600 hover:text-red-900">Delete</button>
                        </td>
                    </tr>`;
            });
            tableHTML += `</tbody></table>`;
            coursesListDiv.innerHTML = tableHTML;
             // Re-attach event listeners if needed, or use global app object
            document.querySelectorAll('#coursesList .text-indigo-600').forEach(btn => {
                const id = btn.parentElement.parentElement.querySelector('td:first-child').textContent; // Not ideal, better to use data-id
                 // For simplicity, we'll re-fetch the course object to edit.
            });
        }
        
        // Expose functions to global scope for inline event handlers
        window.app = { ...window.app, editCourse, deleteCourse };


        // --- Students ---
        const addStudentForm = document.getElementById('addStudentForm');
        const studentsListDiv = document.getElementById('studentsList');
        const studentFormTitle = document.getElementById('studentFormTitle');
        const addUpdateStudentBtn = document.getElementById('addUpdateStudentBtn');
        const cancelStudentEditBtn = document.getElementById('cancelStudentEditBtn');
        let editingStudentId = null;

        addStudentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const studentData = {
                name: addStudentForm.studentName.value,
                studentId: addStudentForm.studentId.value,
                address: addStudentForm.studentAddress.value,
            };
            if (editingStudentId) {
                await updateData('students', editingStudentId, studentData);
            } else {
                await addData('students', studentData);
            }
            resetStudentForm();
            loadStudents(); // Refresh list
        });
        
        cancelStudentEditBtn.addEventListener('click', resetStudentForm);

        function resetStudentForm() {
            addStudentForm.reset();
            editingStudentId = null;
            studentFormTitle.textContent = "Add New Student";
            addUpdateStudentBtn.textContent = "Add Student";
            cancelStudentEditBtn.classList.add('hidden');
            addStudentForm.studentDbId.value = '';
        }

        function editStudent(student) {
            editingStudentId = student.id;
            addStudentForm.studentDbId.value = student.id;
            addStudentForm.studentName.value = student.name;
            addStudentForm.studentId.value = student.studentId;
            addStudentForm.studentAddress.value = student.address;

            studentFormTitle.textContent = "Edit Student";
            addUpdateStudentBtn.textContent = "Update Student";
            cancelStudentEditBtn.classList.remove('hidden');
            window.scrollTo({ top: addStudentForm.offsetTop - 20, behavior: 'smooth' });
        }

        async function deleteStudent(studentDbId) {
            await deleteData('students', studentDbId);
            loadStudents(); // Refresh list
        }

        function renderStudents(students) {
            if (students.length === 0) {
                studentsListDiv.innerHTML = '<p class="text-gray-500 text-center">No students added yet.</p>';
                return;
            }
             students.sort((a,b) => (a.studentId || "").localeCompare(b.studentId || "") || (a.name || "").localeCompare(b.name || ""));

            let tableHTML = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student ID</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider actions-cell">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">`;
            
            students.forEach(student => {
                tableHTML += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.studentId}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.name}</td>
                        <td class="px-6 py-4 whitespace-normal text-sm text-gray-500">${student.address}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium actions-cell">
                            <button onclick="window.app.editStudent('${student.id}')" class="text-indigo-600 hover:text-indigo-900 mr-2">Edit</button>
                            <button onclick="window.app.deleteStudent('${student.id}')" class="text-red-600 hover:text-red-900">Delete</button>
                        </td>
                    </tr>`;
            });
            tableHTML += `</tbody></table>`;
            studentsListDiv.innerHTML = tableHTML;
        }
        window.app = { ...window.app, editStudent, deleteStudent };


        // --- Teachers (Faculty) ---
        const addTeacherForm = document.getElementById('addTeacherForm');
        const teachersListDiv = document.getElementById('teachersList');
        const teacherFormTitle = document.getElementById('teacherFormTitle');
        const addUpdateTeacherBtn = document.getElementById('addUpdateTeacherBtn');
        const cancelTeacherEditBtn = document.getElementById('cancelTeacherEditBtn');
        let editingTeacherId = null;

        addTeacherForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const teacherData = {
                name: addTeacherForm.teacherName.value,
                initials: addTeacherForm.teacherInitials.value,
                type: addTeacherForm.teacherType.value,
            };
            if (editingTeacherId) {
                await updateData('teachers', editingTeacherId, teacherData);
            } else {
                await addData('teachers', teacherData);
            }
            resetTeacherForm();
            loadTeachers(); // Refresh list and dependent dropdowns
        });

        cancelTeacherEditBtn.addEventListener('click', resetTeacherForm);

        function resetTeacherForm() {
            addTeacherForm.reset();
            editingTeacherId = null;
            teacherFormTitle.textContent = "Add New Faculty";
            addUpdateTeacherBtn.textContent = "Add Faculty";
            cancelTeacherEditBtn.classList.add('hidden');
            addTeacherForm.teacherDbId.value = '';
        }

        function editTeacher(teacher) {
            editingTeacherId = teacher.id;
            addTeacherForm.teacherDbId.value = teacher.id;
            addTeacherForm.teacherName.value = teacher.name;
            addTeacherForm.teacherInitials.value = teacher.initials;
            addTeacherForm.teacherType.value = teacher.type;

            teacherFormTitle.textContent = "Edit Faculty";
            addUpdateTeacherBtn.textContent = "Update Faculty";
            cancelTeacherEditBtn.classList.remove('hidden');
             window.scrollTo({ top: addTeacherForm.offsetTop - 20, behavior: 'smooth' });
        }

        async function deleteTeacher(teacherDbId) {
            await deleteData('teachers', teacherDbId);
            loadTeachers(); // Refresh list and dependent dropdowns
        }

        function renderTeachers(teachers) {
            if (teachers.length === 0) {
                teachersListDiv.innerHTML = '<p class="text-gray-500 text-center">No faculty added yet.</p>';
                return;
            }
            teachers.sort((a,b) => (a.initials || "").localeCompare(b.initials || "") || (a.name || "").localeCompare(b.name || ""));

            let tableHTML = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Initials</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider actions-cell">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">`;
            
            teachers.forEach(teacher => {
                tableHTML += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${teacher.initials}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${teacher.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${teacher.type}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium actions-cell">
                            <button onclick="window.app.editTeacher('${teacher.id}')" class="text-indigo-600 hover:text-indigo-900 mr-2">Edit</button>
                            <button onclick="window.app.deleteTeacher('${teacher.id}')" class="text-red-600 hover:text-red-900">Delete</button>
                        </td>
                    </tr>`;
            });
            tableHTML += `</tbody></table>`;
            teachersListDiv.innerHTML = tableHTML;
            populateFacultyDropdowns(teachers); // Update dropdowns that use faculty
        }
        window.app = { ...window.app, editTeacher, deleteTeacher };

        function populateFacultyDropdowns(teachers) {
            const courseFacultySelect = document.getElementById('courseFaculty');
            const eventAffectedFacultySelect = document.getElementById('eventAffectedFaculty');
            
            const selects = [courseFacultySelect, eventAffectedFacultySelect];
            
            selects.forEach(select => {
                if (!select) return;
                const currentValue = select.value;
                select.innerHTML = '<option value="">-- Select Faculty --</option>'; // Clear existing options
                teachers.forEach(teacher => {
                    const option = document.createElement('option');
                    option.value = teacher.id; // Store Firestore ID
                    option.textContent = `${teacher.name} (${teacher.initials})`;
                    select.appendChild(option);
                });
                select.value = currentValue; // Restore selected value if possible
            });
        }

        // --- Course Offerings ---
        const addCourseOfferingForm = document.getElementById('addCourseOfferingForm');
        const courseOfferingsListDiv = document.getElementById('courseOfferingsList');
        const availableCoursesForOfferingDiv = document.getElementById('availableCoursesForOffering');
        const offeringFormTitle = document.getElementById('courseOfferingFormTitle');
        const addUpdateOfferingBtn = document.getElementById('addUpdateOfferingBtn');
        const cancelOfferingEditBtn = document.getElementById('cancelOfferingEditBtn');
        let editingOfferingId = null;
        let allCoursesCache = []; // Cache for courses to populate offering form

        addCourseOfferingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const selectedCourses = Array.from(availableCoursesForOfferingDiv.querySelectorAll('input[type="checkbox"]:checked'))
                                      .map(cb => cb.value); // These are course IDs
            
            if (selectedCourses.length === 0) {
                showMessage("Please select at least one course for the offering.", true);
                return;
            }

            const offeringData = {
                semester: addCourseOfferingForm.offeringSemester.value,
                courseIds: selectedCourses, // Array of course IDs
            };

            if (editingOfferingId) {
                await updateData('courseOfferings', editingOfferingId, offeringData);
            } else {
                await addData('courseOfferings', offeringData);
            }
            resetCourseOfferingForm();
            loadCourseOfferings(); // Refresh list
        });

        cancelOfferingEditBtn.addEventListener('click', resetCourseOfferingForm);

        function resetCourseOfferingForm() {
            addCourseOfferingForm.reset();
            editingOfferingId = null;
            offeringFormTitle.textContent = "Add Course Offering for Semester";
            addUpdateOfferingBtn.textContent = "Add Course Offering";
            cancelOfferingEditBtn.classList.add('hidden');
            addCourseOfferingForm.courseOfferingId.value = '';
            // Uncheck all checkboxes
            availableCoursesForOfferingDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        }
        
        function populateAvailableCoursesForOffering(courses, selectedCourseIds = []) {
            allCoursesCache = courses; // Update cache
            if (courses.length === 0) {
                availableCoursesForOfferingDiv.innerHTML = '<p class="text-gray-500">No courses available in curriculum. Add courses first.</p>';
                return;
            }
            let checkboxesHTML = '';
            courses.forEach(course => {
                const isChecked = selectedCourseIds.includes(course.id) ? 'checked' : '';
                checkboxesHTML += `
                    <label class="flex items-center space-x-2 p-2 border rounded-md hover:bg-gray-50 cursor-pointer">
                        <input type="checkbox" value="${course.id}" ${isChecked} class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded">
                        <span>${course.code} - ${course.name} (${course.curriculumType})</span>
                    </label>`;
            });
            availableCoursesForOfferingDiv.innerHTML = checkboxesHTML;
        }

        function editCourseOffering(offering) {
            editingOfferingId = offering.id;
            addCourseOfferingForm.courseOfferingId.value = offering.id;
            addCourseOfferingForm.offeringSemester.value = offering.semester;
            
            // Populate and check the courses
            populateAvailableCoursesForOffering(allCoursesCache, offering.courseIds);

            offeringFormTitle.textContent = "Edit Course Offering";
            addUpdateOfferingBtn.textContent = "Update Offering";
            cancelOfferingEditBtn.classList.remove('hidden');
            window.scrollTo({ top: addCourseOfferingForm.offsetTop - 20, behavior: 'smooth' });
        }

        async function deleteCourseOffering(offeringId) {
            await deleteData('courseOfferings', offeringId);
            loadCourseOfferings(); // Refresh list
        }

        function renderCourseOfferings(offerings) {
            if (offerings.length === 0) {
                courseOfferingsListDiv.innerHTML = '<p class="text-gray-500 text-center">No course offerings added yet.</p>';
                return;
            }
             offerings.sort((a,b) => (a.semester || "").localeCompare(b.semester || ""));


            let html = '';
            offerings.forEach(offering => {
                html += `
                <div class="expandable-item mb-2 rounded-md" data-offering-id="${offering.id}">
                    <span>${offering.semester} (${offering.courseIds?.length || 0} courses)</span>
                    <span class="arrow text-xl">&#9654;</span>
                </div>
                <div class="expandable-content bg-white border border-gray-200 rounded-b-md p-4">
                    <p class="font-semibold mb-2">Courses in this offering:</p>
                    <ul class="list-disc pl-5 space-y-1">`;
                
                if (offering.courseIds && offering.courseIds.length > 0) {
                    offering.courseIds.forEach(courseId => {
                        const course = allCoursesCache.find(c => c.id === courseId);
                        html += `<li>${course ? `${course.code} - ${course.name}` : `Unknown Course (ID: ${courseId})`}</li>`;
                    });
                } else {
                    html += `<li>No courses assigned to this offering.</li>`;
                }
                
                html += `</ul>
                    <div class="mt-4 actions-cell">
                        <button onclick="window.app.editCourseOffering('${offering.id}')" class="text-indigo-600 hover:text-indigo-900 mr-2 text-sm">Edit Offering</button>
                        <button onclick="window.app.deleteCourseOffering('${offering.id}')" class="text-red-600 hover:text-red-900 text-sm">Delete Offering</button>
                    </div>
                </div>`;
            });
            courseOfferingsListDiv.innerHTML = html;
            
            // Add event listeners for expandable items
            document.querySelectorAll('.expandable-item').forEach(item => {
                item.addEventListener('click', () => {
                    item.classList.toggle('active');
                    const content = item.nextElementSibling;
                    content.classList.toggle('active');
                });
            });
            populateRoutineSemesterFilter(offerings); // For Routine View
            populateRoutineMakerSemesterFilter(offerings); // For Routine Maker
            populateAttendanceCourseDropdown(offerings, allCoursesCache); // For Attendance
        }
        window.app = { ...window.app, editCourseOffering, deleteCourseOffering };


        // --- Routine Entries (Part of Calendar Events Tab) ---
        const addRoutineForm = document.getElementById('addRoutineForm');
        const routineListDiv = document.getElementById('routineList');
        const routineFormTitleEl = document.getElementById('routineFormTitle'); // Renamed to avoid conflict
        const addUpdateRoutineBtn = document.getElementById('addUpdateRoutineBtn');
        const cancelRoutineEditBtn = document.getElementById('cancelRoutineEditBtn');
        let editingRoutineId = null;

        addRoutineForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const routineData = {
                courseId: addRoutineForm.routineCourse.value, // Store course ID
                day: addRoutineForm.routineDay.value,
                startTime: addRoutineForm.routineStartTime.value,
                endTime: addRoutineForm.routineEndTime.value,
                room: addRoutineForm.routineRoom.value,
            };
            if (editingRoutineId) {
                await updateData('routines', editingRoutineId, routineData);
            } else {
                await addData('routines', routineData);
            }
            resetRoutineForm();
            loadRoutines(); // Refresh list
        });
        
        cancelRoutineEditBtn.addEventListener('click', resetRoutineForm);

        function resetRoutineForm() {
            addRoutineForm.reset();
            editingRoutineId = null;
            routineFormTitleEl.textContent = "Add Routine Entry";
            addUpdateRoutineBtn.textContent = "Add Routine Entry";
            cancelRoutineEditBtn.classList.add('hidden');
            addRoutineForm.routineId.value = '';
        }

        function editRoutineEntry(entry) {
            editingRoutineId = entry.id;
            addRoutineForm.routineId.value = entry.id;
            addRoutineForm.routineCourse.value = entry.courseId;
            addRoutineForm.routineDay.value = entry.day;
            addRoutineForm.routineStartTime.value = entry.startTime;
            addRoutineForm.routineEndTime.value = entry.endTime;
            addRoutineForm.routineRoom.value = entry.room;

            routineFormTitleEl.textContent = "Edit Routine Entry";
            addUpdateRoutineBtn.textContent = "Update Entry";
            cancelRoutineEditBtn.classList.remove('hidden');
            window.scrollTo({ top: addRoutineForm.offsetTop - 20, behavior: 'smooth' });
        }

        async function deleteRoutineEntry(entryId) {
            await deleteData('routines', entryId);
            loadRoutines(); // Refresh list
        }

        function renderRoutines(routines) {
            if (routines.length === 0) {
                routineListDiv.innerHTML = '<p class="text-gray-500 text-center">No routine entries added yet.</p>';
                return;
            }
            // Sort routines by day, then start time
            const dayOrder = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            routines.sort((a, b) => {
                const dayComparison = dayOrder.indexOf(a.day) - dayOrder.indexOf(b.day);
                if (dayComparison !== 0) return dayComparison;
                return (a.startTime || "").localeCompare(b.startTime || "");
            });


            let tableHTML = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Course</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Day</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Room</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider actions-cell">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">`;
            
            routines.forEach(entry => {
                const course = allCoursesCache.find(c => c.id === entry.courseId);
                const courseDisplay = course ? `${course.code} - ${course.name}` : `Unknown Course (ID: ${entry.courseId})`;
                tableHTML += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${courseDisplay}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${entry.day}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${entry.startTime} - ${entry.endTime}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${entry.room}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium actions-cell">
                            <button onclick="window.app.editRoutineEntry('${entry.id}')" class="text-indigo-600 hover:text-indigo-900 mr-2">Edit</button>
                            <button onclick="window.app.deleteRoutineEntry('${entry.id}')" class="text-red-600 hover:text-red-900">Delete</button>
                        </td>
                    </tr>`;
            });
            tableHTML += `</tbody></table>`;
            routineListDiv.innerHTML = tableHTML;
        }
        window.app = { ...window.app, editRoutineEntry, deleteRoutineEntry };
        
        function populateRoutineCourseDropdown(courses) {
            const routineCourseSelect = document.getElementById('routineCourse');
            const eventAffectedCourseSelect = document.getElementById('eventAffectedCourse');
            const outlineCourseSelect = document.getElementById('outlineCourseSelect');

            const selects = [routineCourseSelect, eventAffectedCourseSelect, outlineCourseSelect];
            selects.forEach(select => {
                if (!select) return;
                const currentValue = select.value;
                select.innerHTML = '<option value="">-- Select Course --</option>'; // Clear existing options
                courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.id; // Store Firestore ID
                    option.textContent = `${course.code} - ${course.name}`;
                    select.appendChild(option);
                });
                select.value = currentValue; // Restore selected value if possible
            });
        }


        // --- Events (Holidays, Agendas - Part of Calendar Events Tab) ---
        const addEventForm = document.getElementById('addEventForm');
        const eventsListDiv = document.getElementById('eventsList');
        const eventFormTitleEl = document.getElementById('eventFormTitle'); // Renamed
        const addUpdateEventBtn = document.getElementById('addUpdateEventBtn');
        const cancelEventEditBtn = document.getElementById('cancelEventEditBtn');
        const eventTypeSelect = document.getElementById('eventType');
        const eventAffectedFacultyContainer = document.getElementById('eventAffectedFacultyContainer');
        const eventAffectedCourseContainer = document.getElementById('eventAffectedCourseContainer');
        let editingEventId = null;

        eventTypeSelect.addEventListener('change', function() {
            const type = this.value;
            eventAffectedFacultyContainer.classList.toggle('hidden', !['Teacher Absence', 'Sick Leave'].includes(type));
            eventAffectedCourseContainer.classList.toggle('hidden', type !== 'Make-up Class');
        });

        addEventForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const eventData = {
                type: addEventForm.eventType.value,
                name: addEventForm.eventName.value,
                startDate: addEventForm.eventStartDate.value,
                endDate: addEventForm.eventEndDate.value || null,
                startTime: addEventForm.eventStartTime.value || null,
                endTime: addEventForm.eventEndTime.value || null,
                affectedFacultyId: addEventForm.eventAffectedFaculty.value || null,
                affectedCourseId: addEventForm.eventAffectedCourse.value || null,
            };
            if (editingEventId) {
                await updateData('events', editingEventId, eventData);
            } else {
                await addData('events', eventData);
            }
            resetEventForm();
            loadEvents(); // Refresh list
        });

        cancelEventEditBtn.addEventListener('click', resetEventForm);

        function resetEventForm() {
            addEventForm.reset();
            editingEventId = null;
            eventFormTitleEl.textContent = "Add New Event/Holiday/Agenda";
            addUpdateEventBtn.textContent = "Add Event";
            cancelEventEditBtn.classList.add('hidden');
            addEventForm.eventId.value = '';
            eventAffectedFacultyContainer.classList.add('hidden');
            eventAffectedCourseContainer.classList.add('hidden');
        }

        function editCalendarEvent(event) { // Renamed to avoid conflict
            editingEventId = event.id;
            addEventForm.eventId.value = event.id;
            addEventForm.eventType.value = event.type;
            addEventForm.eventName.value = event.name;
            addEventForm.eventStartDate.value = event.startDate;
            addEventForm.eventEndDate.value = event.endDate || '';
            addEventForm.eventStartTime.value = event.startTime || '';
            addEventForm.eventEndTime.value = event.endTime || '';
            
            // Trigger change to show/hide conditional fields
            eventTypeSelect.dispatchEvent(new Event('change'));
            
            addEventForm.eventAffectedFaculty.value = event.affectedFacultyId || '';
            addEventForm.eventAffectedCourse.value = event.affectedCourseId || '';


            eventFormTitleEl.textContent = "Edit Event/Holiday/Agenda";
            addUpdateEventBtn.textContent = "Update Event";
            cancelEventEditBtn.classList.remove('hidden');
            window.scrollTo({ top: addEventForm.offsetTop - 20, behavior: 'smooth' });
        }

        async function deleteCalendarEvent(eventId) { // Renamed
            await deleteData('events', eventId);
            loadEvents(); // Refresh list
        }

        function renderEvents(events) { // For the Add/Remove tab list
            if (events.length === 0) {
                eventsListDiv.innerHTML = '<p class="text-gray-500 text-center">No events added yet.</p>';
                return;
            }
             events.sort((a,b) => (a.startDate || "").localeCompare(b.startDate || "") || (a.name || "").localeCompare(b.name || ""));

            let tableHTML = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name/Desc</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date(s)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider actions-cell">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">`;
            
            events.forEach(event => {
                let dateRange = event.startDate;
                if (event.endDate && event.endDate !== event.startDate) {
                    dateRange += ` to ${event.endDate}`;
                }
                if(event.startTime) dateRange += ` (${event.startTime}${event.endTime ? ' - ' + event.endTime : ''})`;

                tableHTML += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${event.type}</td>
                        <td class="px-6 py-4 whitespace-normal text-sm text-gray-500">${event.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${dateRange}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium actions-cell">
                            <button onclick="window.app.editCalendarEvent('${event.id}')" class="text-indigo-600 hover:text-indigo-900 mr-2">Edit</button>
                            <button onclick="window.app.deleteCalendarEvent('${event.id}')" class="text-red-600 hover:text-red-900">Delete</button>
                        </td>
                    </tr>`;
            });
            tableHTML += `</tbody></table>`;
            eventsListDiv.innerHTML = tableHTML;
        }
        window.app = { ...window.app, editCalendarEvent, deleteCalendarEvent };


        // --- Home Section Data Loading ---
        function loadHomeData() {
            if (!currentUserId) return;
            showLoading(true);
            // Fetch events for today and upcoming
            const today = new Date().toISOString().split('T')[0];
            const eventsAgendasList = document.getElementById('eventsAgendasList');
            const upcomingEventsList = document.getElementById('upcomingEventsList');

            fetchData('events', allEvents => {
                const todayEvents = allEvents.filter(event => {
                    return event.startDate === today || (event.endDate && event.startDate <= today && event.endDate >= today);
                });
                const upcoming = allEvents.filter(event => event.startDate > today).sort((a,b) => a.startDate.localeCompare(b.startDate)).slice(0, 5); // Show next 5

                if (todayEvents.length > 0) {
                    eventsAgendasList.innerHTML = todayEvents.map(e => `<div class="p-2 bg-red-50 border border-red-200 rounded-md"><strong>${e.type}:</strong> ${e.name} (${e.startDate}${e.startTime ? ' ' + e.startTime : ''})</div>`).join('');
                } else {
                    eventsAgendasList.innerHTML = '<p class="text-gray-500">No events scheduled for today.</p>';
                }

                if (upcoming.length > 0) {
                    upcomingEventsList.innerHTML = upcoming.map(e => `<div class="p-2 bg-blue-50 border border-blue-200 rounded-md"><strong>${e.type}:</strong> ${e.name} (${e.startDate})</div>`).join('');
                } else {
                    upcomingEventsList.innerHTML = '<p class="text-gray-500">No upcoming events.</p>';
                }
                showLoading(false);
            });
        }

        // --- Load Initial Data and Populate Dropdowns ---
        async function loadInitialData() {
            if (!currentUserId) {
                console.log("Cannot load initial data, user not authenticated.");
                return;
            }
            console.log("Loading initial data...");
            showLoading(true);
            clearSubscribers(); // Clear previous listeners before setting new ones

            // Chain loading or use Promise.all if independent
            const unsubCourses = fetchData('courses', courses => {
                allCoursesCache = courses; // Update cache
                renderCourses(courses);
                populateAvailableCoursesForOffering(courses);
                populateRoutineCourseDropdown(courses); // For routine form, event form, outline generator
                loadCourseOfferings(); // Load offerings after courses are loaded
                loadRoutines(); // Load routines after courses
            });
            unsubscribers.push(unsubCourses);

            const unsubStudents = fetchData('students', renderStudents);
            unsubscribers.push(unsubStudents);
            
            const unsubTeachers = fetchData('teachers', teachers => {
                renderTeachers(teachers);
                // populateFacultyDropdowns is called inside renderTeachers
            });
            unsubscribers.push(unsubTeachers);

            const unsubEvents = fetchData('events', events => {
                renderEvents(events); // For the Add/Remove tab
                loadHomeData(); // Refresh home page events
            });
            unsubscribers.push(unsubEvents);
            
            // Course Offerings and Routines are loaded after courses are fetched
            // loadCourseOfferings(); 
            // loadRoutines();

            console.log("Initial data loading setup complete.");
            // showLoading(false); // Loading will be hidden by individual load functions or setActiveSection
        }
        
        // Specific load functions for each data type (called by loadInitialData or form submissions)
        function loadCourses() { if(currentUserId) fetchData('courses', courses => { allCoursesCache = courses; renderCourses(courses); populateAvailableCoursesForOffering(courses); populateRoutineCourseDropdown(courses);}); }
        function loadStudents() { if(currentUserId) fetchData('students', renderStudents); }
        function loadTeachers() { if(currentUserId) fetchData('teachers', renderTeachers); }
        function loadCourseOfferings() { if(currentUserId) fetchData('courseOfferings', renderCourseOfferings); }
        function loadRoutines() { if(currentUserId) fetchData('routines', renderRoutines); }
        function loadEvents() { if(currentUserId) fetchData('events', events => { renderEvents(events); loadHomeData(); }); }


        // --- Drag and Drop Routine Maker ---
        const draggableCoursesPool = document.getElementById('draggableCoursesPool');
        const routineGridTable = document.getElementById('dragDropRoutineGrid');
        const routineMakerSemesterFilter = document.getElementById('routineMakerSemesterFilter');
        const clashReportContainer = document.getElementById('clashReportContainer');
        const clashReportList = document.getElementById('clashReportList');
        let draggedItem = null;
        let routineGridData = {}; // Store as { 'day-time': {courseId, courseCode, teacherInitials, room} }

        function initializeRoutineMaker() {
            if (!currentUserId) return;
            showLoading(true);
            // Populate semester filter (done by loadCourseOfferings -> populateRoutineMakerSemesterFilter)
            // Populate draggable courses based on filter (event listener on filter)
            renderRoutineGrid(); // Initial empty grid
            loadOfferedCoursesForMaker(); // Load initial set of courses
            loadSavedRoutineGrid(); // Load any saved routine for the grid
            showLoading(false);
        }
        
        routineMakerSemesterFilter.addEventListener('change', loadOfferedCoursesForMaker);

        async function loadOfferedCoursesForMaker() {
            if (!currentUserId) return;
            showLoading(true);
            const selectedSemester = routineMakerSemesterFilter.value;
            draggableCoursesPool.innerHTML = '<p class="text-gray-400 text-sm">Loading courses...</p>';

            fetchData('courseOfferings', offerings => {
                let offeredCourseIds = new Set();
                if (selectedSemester) {
                    const offering = offerings.find(o => o.semester === selectedSemester);
                    if (offering) {
                        offering.courseIds.forEach(id => offeredCourseIds.add(id));
                    }
                } else { // All offered courses
                    offerings.forEach(o => o.courseIds.forEach(id => offeredCourseIds.add(id)));
                }

                const relevantCourses = allCoursesCache.filter(course => offeredCourseIds.has(course.id));
                renderDraggableCourses(relevantCourses);
                showLoading(false);
            });
        }
        
        function renderDraggableCourses(courses) {
            if (courses.length === 0) {
                draggableCoursesPool.innerHTML = '<p class="text-gray-400 text-sm">No courses offered for this selection, or add courses to curriculum first.</p>';
                return;
            }
            draggableCoursesPool.innerHTML = courses.map(course => {
                const teacher = allTeachersCache.find(t => t.id === course.defaultFacultyId);
                return `
                <div class="draggable-course" draggable="true" data-course-id="${course.id}" data-course-code="${course.code}" data-teacher-initials="${teacher ? teacher.initials : 'N/A'}" data-default-room="${course.defaultRoom || 'N/A'}">
                    <strong>${course.code}</strong> - ${course.name} <br>
                    <small>T: ${teacher ? teacher.initials : 'N/A'}, R: ${course.defaultRoom || 'N/A'}, Sem: ${course.offeredToSemester}</small>
                </div>`;
            }).join('');

            draggableCoursesPool.querySelectorAll('.draggable-course').forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
            });
        }

        function handleDragStart(e) {
            draggedItem = e.target.closest('.draggable-course');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', draggedItem.dataset.courseId); // Not strictly needed if using global `draggedItem`
            setTimeout(() => { // Make it disappear from original spot
                // draggedItem.classList.add('dragging'); // Or hide it if you don't want a copy in the pool
            }, 0);
        }
        
        const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday"]; // Typical for CWU
        const timeSlots = [
            "08:30 AM - 10:00 AM", "10:00 AM - 11:30 AM", "11:30 AM - 01:00 PM",
            "01:00 PM - 01:30 PM (Break)",
            "01:30 PM - 03:00 PM", "03:00 PM - 04:30 PM"
        ];

        function renderRoutineGrid() {
            let headHTML = '<thead><tr><th class="time-slot-header">Time</th>';
            days.forEach(day => headHTML += `<th>${day}</th>`);
            headHTML += '</tr></thead>';

            let bodyHTML = '<tbody>';
            timeSlots.forEach(slot => {
                bodyHTML += `<tr><td class="time-slot-header ${slot.includes('Break') ? 'bg-gray-200' : ''}">${slot}</td>`;
                days.forEach(day => {
                    const cellId = `${day}-${slot}`;
                    const cellData = routineGridData[cellId];
                    bodyHTML += `
                        <td class="drop-target ${slot.includes('Break') ? 'bg-gray-100 pointer-events-none' : ''}" data-day="${day}" data-time="${slot}">
                            ${cellData ? `
                                <div class="routine-item" data-course-id="${cellData.courseId}">
                                    <span>${cellData.courseCode} (${cellData.teacherInitials}) R:${cellData.room}</span>
                                    <button class="delete-btn" onclick="window.app.removeRoutineItemFromGrid(event, '${cellId}')">&times;</button>
                                </div>` : ''}
                        </td>`;
                });
                bodyHTML += '</tr>';
            });
            bodyHTML += '</tbody>';
            routineGridTable.innerHTML = headHTML + bodyHTML;

            // Add drag-and-drop listeners to new cells
            routineGridTable.querySelectorAll('.drop-target').forEach(cell => {
                if (cell.classList.contains('pointer-events-none')) return; // Skip break cells
                cell.addEventListener('dragover', handleDragOver);
                cell.addEventListener('dragenter', handleDragEnter);
                cell.addEventListener('dragleave', handleDragLeave);
                cell.addEventListener('drop', handleDrop);
            });
            checkClashes();
        }
        
        function handleDragOver(e) {
            e.preventDefault(); // Necessary to allow dropping
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDragEnter(e) {
            e.preventDefault();
            if (e.target.classList.contains('drop-target')) {
                e.target.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            if (e.target.classList.contains('drop-target')) {
                e.target.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            const targetCell = e.target.closest('.drop-target');
            if (targetCell && draggedItem && !targetCell.classList.contains('pointer-events-none')) {
                targetCell.classList.remove('drag-over');
                
                const courseId = draggedItem.dataset.courseId;
                const courseCode = draggedItem.dataset.courseCode;
                const teacherInitials = draggedItem.dataset.teacherInitials;
                const defaultRoom = draggedItem.dataset.defaultRoom;
                const day = targetCell.dataset.day;
                const time = targetCell.dataset.time;
                const cellId = `${day}-${time}`;

                // Basic check: don't add if something is already there (or implement swap/overwrite)
                if (targetCell.querySelector('.routine-item')) {
                    showMessage("Slot is already occupied. Remove the existing item first or implement swapping.", true);
                    return;
                }

                routineGridData[cellId] = { courseId, courseCode, teacherInitials, room: defaultRoom };
                renderRoutineGrid(); // Re-render the grid with the new item
                // draggedItem.remove(); // Remove from the pool if it's a one-time drag
                // draggedItem.classList.remove('dragging');
                draggedItem = null;
            }
        }
        
        function removeRoutineItemFromGrid(event, cellId) {
            event.stopPropagation(); // Prevent drop event if button is inside cell
            if (routineGridData[cellId]) {
                delete routineGridData[cellId];
                renderRoutineGrid(); // Re-render
            }
        }
        window.app = { ...window.app, removeRoutineItemFromGrid };

        document.getElementById('saveRoutineBtn').addEventListener('click', async () => {
            if (!currentUserId) { showMessage("Not authenticated", true); return; }
            showLoading(true);
            try {
                // Serialize complex objects if necessary, Firestore handles simple objects well.
                // For routineGridData, it's an object of objects, which is fine.
                const routineDocRef = doc(db, `${dbPrefix}/routines`, 'dragDropGridData'); // Single doc for the grid
                await setDoc(routineDocRef, { grid: routineGridData, updatedAt: serverTimestamp() });
                showMessage("Routine grid saved successfully!", false);
            } catch (error) {
                console.error("Error saving routine grid: ", error);
                showMessage(`Error saving routine grid: ${error.message}`, true);
            } finally {
                showLoading(false);
            }
        });

        async function loadSavedRoutineGrid() {
            if (!currentUserId) return;
            showLoading(true);
            try {
                const routineDocRef = doc(db, `${dbPrefix}/routines`, 'dragDropGridData');
                const docSnap = await getDoc(routineDocRef);
                if (docSnap.exists()) {
                    routineGridData = docSnap.data().grid || {};
                } else {
                    routineGridData = {}; // No saved data
                }
                renderRoutineGrid();
            } catch (error) {
                console.error("Error loading saved routine grid: ", error);
                routineGridData = {};
                renderRoutineGrid(); // Render empty grid on error
            } finally {
                showLoading(false);
            }
        }
        
        document.getElementById('clearRoutineBtn').addEventListener('click', () => {
            if (confirm("Are you sure you want to clear the entire grid? Unsaved changes will be lost.")) {
                routineGridData = {};
                renderRoutineGrid();
            }
        });

        function checkClashes() {
            clashReportList.innerHTML = '';
            clashReportContainer.classList.add('hidden');
            let clashesFound = false;
            const teacherSchedule = {}; // { teacherInitials: [{day, time, courseCode, room}] }
            const roomSchedule = {};    // { room: [{day, time, courseCode}] }

            for (const cellId in routineGridData) {
                const entry = routineGridData[cellId];
                const [day, time] = cellId.split('-');

                // Teacher clash
                if (entry.teacherInitials !== 'N/A') {
                    if (!teacherSchedule[entry.teacherInitials]) teacherSchedule[entry.teacherInitials] = [];
                    const existingTeacherSlot = teacherSchedule[entry.teacherInitials].find(s => s.day === day && s.time === time);
                    if (existingTeacherSlot) {
                        clashReportList.innerHTML += `<li>Teacher Clash: ${entry.teacherInitials} has ${entry.courseCode} and ${existingTeacherSlot.courseCode} at ${day} ${time}.</li>`;
                        clashesFound = true;
                    }
                    teacherSchedule[entry.teacherInitials].push({ day, time, courseCode: entry.courseCode, room: entry.room });
                }

                // Room clash
                if (entry.room !== 'N/A') {
                    if (!roomSchedule[entry.room]) roomSchedule[entry.room] = [];
                     const existingRoomSlot = roomSchedule[entry.room].find(s => s.day === day && s.time === time);
                    if (existingRoomSlot) {
                        clashReportList.innerHTML += `<li>Room Clash: Room ${entry.room} is booked for ${entry.courseCode} and ${existingRoomSlot.courseCode} at ${day} ${time}.</li>`;
                        clashesFound = true;
                    }
                    roomSchedule[entry.room].push({ day, time, courseCode: entry.courseCode });
                }
            }

            if (clashesFound) {
                clashReportContainer.classList.remove('hidden');
            } else {
                 clashReportList.innerHTML = '<li class="solution">No clashes detected.</li>';
                 clashReportContainer.classList.remove('hidden'); // Show "No clashes" message
            }
        }


        // --- Full Routine View Section ---
        const routineViewSemesterFilter = document.getElementById('routineViewSemesterFilter');
        const routineFullDisplay = document.getElementById('routineFullDisplay');
        let allTeachersCache = []; // Cache for teachers

        async function loadAndDisplayFullRoutine() {
            if (!currentUserId) return;
            showLoading(true);
            // Fetch teachers first to map initials
            fetchData('teachers', teachers => {
                allTeachersCache = teachers;
                // Then fetch routine entries (saved from drag & drop or manual entry)
                const routineDocRef = doc(db, `${dbPrefix}/routines`, 'dragDropGridData');
                getDoc(routineDocRef).then(docSnap => {
                    let gridData = {};
                    if (docSnap.exists()) {
                        gridData = docSnap.data().grid || {};
                    }
                    // Also fetch individual routine entries if any (manual entries)
                    fetchData('routines', manualEntries => {
                        const combinedRoutine = { ...gridData }; // Start with grid data
                        manualEntries.forEach(entry => {
                            const cellId = `${entry.day}-${entry.startTime} - ${entry.endTime}`; // This key needs to match grid format or be handled
                            const course = allCoursesCache.find(c => c.id === entry.courseId);
                            const teacher = course ? allTeachersCache.find(t => t.id === course.defaultFacultyId) : null;
                            
                            // This logic needs to be careful not to overwrite if cellId isn't unique or if time slots differ
                            // For simplicity, let's assume manual entries are displayed separately or merged carefully.
                            // Here, we'll just add them if the slot is free in the grid-like structure.
                            if (!combinedRoutine[cellId] && course) {
                                combinedRoutine[cellId] = {
                                    courseId: entry.courseId,
                                    courseCode: course.code,
                                    teacherInitials: teacher ? teacher.initials : 'N/A',
                                    room: entry.room
                                };
                            }
                        });
                        renderFullRoutineTable(combinedRoutine);
                        showLoading(false);
                    });
                }).catch(error => {
                    console.error("Error loading saved routine grid for view: ", error);
                    routineFullDisplay.innerHTML = '<p class="text-red-500">Error loading routine data.</p>';
                    showLoading(false);
                });
            });
        }
        
        routineViewSemesterFilter.addEventListener('change', () => {
            // This filter is more complex for the full view as it needs to filter courses within the grid.
            // For now, it's mainly for populating the dropdown. Actual filtering of the displayed grid would re-render it.
            loadAndDisplayFullRoutine(); // Re-load and re-render based on filter (can be optimized)
        });

        function populateRoutineSemesterFilter(offerings) {
            const currentVal = routineViewSemesterFilter.value;
            routineViewSemesterFilter.innerHTML = '<option value="">All Semesters / Full Routine</option>';
            offerings.forEach(offering => {
                const option = document.createElement('option');
                option.value = offering.semester;
                option.textContent = offering.semester;
                routineViewSemesterFilter.appendChild(option);
            });
            routineViewSemesterFilter.value = currentVal;
        }
        
        function populateRoutineMakerSemesterFilter(offerings) { // For Routine Maker Tool
            const currentVal = routineMakerSemesterFilter.value;
            routineMakerSemesterFilter.innerHTML = '<option value="">All Offered Courses</option>';
             offerings.forEach(offering => {
                const option = document.createElement('option');
                option.value = offering.semester;
                option.textContent = offering.semester;
                routineMakerSemesterFilter.appendChild(option);
            });
            routineMakerSemesterFilter.value = currentVal;
        }


        function renderFullRoutineTable(gridDataToDisplay) {
            // Filter gridDataToDisplay based on routineViewSemesterFilter.value
            const selectedSemester = routineViewSemesterFilter.value;
            let filteredGridData = {};

            if (selectedSemester) {
                // Find courses offered in the selected semester
                const offeringForSemester = allCourseOfferingsCache.find(o => o.semester === selectedSemester);
                if (offeringForSemester) {
                    const coursesInSemester = new Set(offeringForSemester.courseIds);
                    for (const cellId in gridDataToDisplay) {
                        if (coursesInSemester.has(gridDataToDisplay[cellId].courseId)) {
                            filteredGridData[cellId] = gridDataToDisplay[cellId];
                        }
                    }
                } else {
                     // No offering for this semester, so show nothing or all? For now, show nothing from grid.
                }
            } else {
                filteredGridData = gridDataToDisplay; // Show all if no filter
            }


            let headHTML = '<thead><tr><th class="time-slot-header">Time</th>';
            days.forEach(day => headHTML += `<th>${day}</th>`);
            headHTML += '</tr></thead>';

            let bodyHTML = '<tbody>';
            timeSlots.forEach(slot => {
                bodyHTML += `<tr><td class="time-slot-header ${slot.includes('Break') ? 'bg-gray-200' : ''}">${slot}</td>`;
                days.forEach(day => {
                    const cellId = `${day}-${slot}`; // This key format needs to match how data is stored/retrieved
                    const cellData = filteredGridData[cellId];
                    bodyHTML += `<td class="${slot.includes('Break') ? 'bg-gray-100' : ''}">`;
                    if (cellData) {
                        const course = allCoursesCache.find(c => c.id === cellData.courseId);
                        const teacher = course ? allTeachersCache.find(t => t.id === course.defaultFacultyId || t.id === cellData.teacherId) : null; // Check both default and potentially assigned
                        bodyHTML += `
                            <div class="p-1 rounded bg-red-100 border border-red-300 text-xs">
                                <strong>${cellData.courseCode || (course ? course.code : 'N/A')}</strong><br>
                                ${teacher ? teacher.initials : (cellData.teacherInitials || 'N/A')}<br>
                                Room: ${cellData.room || (course ? course.defaultRoom : 'N/A')}
                            </div>`;
                    }
                    bodyHTML += `</td>`;
                });
                bodyHTML += '</tr>';
            });
            bodyHTML += '</tbody>';
            routineFullDisplay.innerHTML = `<table class="routine-grid">${headHTML}${bodyHTML}</table>`;
            if (Object.keys(filteredGridData).length === 0 && selectedSemester) {
                 routineFullDisplay.innerHTML = `<p class="text-gray-500 text-center p-4">No classes scheduled in the grid for semester: ${selectedSemester}. Check 'All Semesters' or the Routine Maker.</p>`;
            } else if (Object.keys(filteredGridData).length === 0) {
                 routineFullDisplay.innerHTML = `<p class="text-gray-500 text-center p-4">Routine is empty. Use the Routine Maker in Tools to build it.</p>`;
            }
        }
        
        let allCourseOfferingsCache = []; // Cache for course offerings
        // Update fetchData for courseOfferings to populate this cache
        function loadCourseOfferingsWithCacheUpdate() {
            if(currentUserId) {
                fetchData('courseOfferings', offerings => {
                    allCourseOfferingsCache = offerings;
                    renderCourseOfferings(offerings); // Original render function
                    // Populate filters that depend on offerings
                    populateRoutineSemesterFilter(offerings);
                    populateRoutineMakerSemesterFilter(offerings);
                    populateAttendanceCourseDropdown(offerings, allCoursesCache);
                });
            }
        }
        // Replace direct loadCourseOfferings() calls with this one if cache is needed broadly
        // For now, renderCourseOfferings already calls the populating functions.


        // --- Attendance Sheet Section ---
        const attendanceCourseSelect = document.getElementById('attendanceCourse');
        const attendanceDateInput = document.getElementById('attendanceDate');
        const generateAttendanceSheetBtn = document.getElementById('generateAttendanceSheetBtn');
        const attendanceSheetDisplay = document.getElementById('attendanceSheetDisplay');
        const attendanceActionButtons = document.getElementById('attendanceActionButtons');

        function populateAttendanceCourseDropdown(offerings, courses) {
            const currentVal = attendanceCourseSelect.value;
            attendanceCourseSelect.innerHTML = '<option value="">-- Select Course --</option>';
            let addedCourses = new Set(); // To avoid duplicates if a course is in multiple offerings (though unlikely for this purpose)

            offerings.forEach(offering => {
                offering.courseIds.forEach(courseId => {
                    if (!addedCourses.has(courseId)) {
                        const course = courses.find(c => c.id === courseId);
                        if (course) {
                            const option = document.createElement('option');
                            option.value = `${offering.semester}::${course.id}`; // Store semester and courseId
                            option.textContent = `${course.code} - ${course.name} (Semester: ${offering.semester})`;
                            attendanceCourseSelect.appendChild(option);
                            addedCourses.add(courseId);
                        }
                    }
                });
            });
            attendanceCourseSelect.value = currentVal;
        }
        
        generateAttendanceSheetBtn.addEventListener('click', async () => {
            const selectedCourseInfo = attendanceCourseSelect.value;
            const selectedDate = attendanceDateInput.value;

            if (!selectedCourseInfo || !selectedDate) {
                showMessage("Please select a course and a date.", true);
                return;
            }
            showLoading(true);
            attendanceSheetDisplay.innerHTML = '<p class="text-gray-500 text-center">Generating sheet...</p>';
            
            const [semester, courseId] = selectedCourseInfo.split('::');
            const course = allCoursesCache.find(c => c.id === courseId);
            const teacher = course ? allTeachersCache.find(t => t.id === course.defaultFacultyId) : null;

            // For now, we don't have student enrollment per course. So, fetch all students.
            // In a real system, you'd fetch students enrolled in this specific course for this semester.
            fetchData('students', students => {
                let tableHTML = `
                    <div class="print-header mb-4 text-center">
                        <h3 class="text-xl font-bold">${course ? course.name : 'Course'} (${course ? course.code : 'N/A'}) - Attendance</h3>
                        <p>Date: ${selectedDate} | Semester: ${semester}</p>
                        <p>Faculty: ${teacher ? teacher.name : 'N/A'}</p>
                    </div>
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SL</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Signature</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">`;
                
                if (students.length > 0) {
                    students.sort((a,b) => (a.studentId || "").localeCompare(b.studentId || "")).forEach((student, index) => {
                        tableHTML += `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${index + 1}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.studentId}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.name}</td>
                                <td class="px-6 py-4 h-12"></td> </tr>`;
                    });
                } else {
                    tableHTML += '<tr><td colspan="4" class="text-center py-4">No students found. Add students first.</td></tr>';
                }
                tableHTML += `</tbody></table>
                <div class="print-footer mt-8 text-xs text-gray-500">
                    <p class="text-right">Faculty Signature: _________________________</p>
                    <p class="text-center mt-2">Central Women's University - Department of English Language and Literature</p>
                </div>`;
                attendanceSheetDisplay.innerHTML = tableHTML;
                attendanceActionButtons.classList.remove('hidden');
                showLoading(false);
            });
        });

        // --- Other View Sections (Data Loading) ---
        function loadAndDisplayCurricula() {
            const displayDiv = document.getElementById('curriculaDisplay');
            displayDiv.innerHTML = '<p class="text-gray-500">Loading curricula data...</p>';
            if (!currentUserId || !allCoursesCache) {
                 displayDiv.innerHTML = '<p class="text-gray-500">No data available or not authenticated.</p>';
                 return;
            }

            const curricula = {}; // { "BA (OBE)": { "1st Semester": [courses], ... }, ... }
            allCoursesCache.forEach(course => {
                if (!curricula[course.curriculumType]) {
                    curricula[course.curriculumType] = {};
                }
                if (!curricula[course.curriculumType][course.offeredToSemester]) {
                    curricula[course.curriculumType][course.offeredToSemester] = [];
                }
                curricula[course.curriculumType][course.offeredToSemester].push(course);
            });
            
            let html = '';
            for (const curriculumName in curricula) {
                html += `<div class="mb-6"><h3 class="text-xl font-semibold text-red-600 mb-3">${curriculumName}</h3>`;
                for (const semesterName in curricula[curriculumName]) {
                    html += `<div class="mb-4 ml-4">
                                <h4 class="text-lg font-medium text-gray-700 mb-2">${semesterName}</h4>
                                <ul class="list-disc pl-5 space-y-1 text-sm">`;
                    curricula[curriculumName][semesterName]
                        .sort((a,b) => (a.code || "").localeCompare(b.code || ""))
                        .forEach(course => {
                        html += `<li><strong>${course.code}</strong> - ${course.name} (${course.credit} credits, Type: ${course.courseType})</li>`;
                    });
                    html += `</ul></div>`;
                }
                html += `</div>`;
            }
            displayDiv.innerHTML = html || '<p class="text-gray-500">No curriculum data structured yet. Add courses with curriculum types and offered semesters.</p>';
        }

        function loadAndDisplayStudentsForView() {
            const displayDiv = document.getElementById('studentsDisplay');
            displayDiv.innerHTML = '<p class="text-gray-500">Loading student data...</p>';
             if (!currentUserId) {
                 displayDiv.innerHTML = '<p class="text-gray-500">Not authenticated.</p>';
                 return;
            }
            fetchData('students', students => {
                if (students.length === 0) {
                    displayDiv.innerHTML = '<p class="text-gray-500">No students registered. Add students via "Add/Remove Data" tool.</p>';
                    return;
                }
                students.sort((a,b) => (a.studentId || "").localeCompare(b.studentId || ""));
                let tableHTML = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">`;
                students.forEach(s => {
                    tableHTML += `<tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${s.studentId}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${s.name}</td>
                                    <td class="px-6 py-4 whitespace-normal text-sm text-gray-500">${s.address}</td>
                                  </tr>`;
                });
                tableHTML += `</tbody></table>`;
                displayDiv.innerHTML = tableHTML;
            });
        }
        function loadAndDisplayFacultyForView() {
            const displayDiv = document.getElementById('facultyDisplay');
            displayDiv.innerHTML = '<p class="text-gray-500">Loading faculty data...</p>';
             if (!currentUserId) {
                 displayDiv.innerHTML = '<p class="text-gray-500">Not authenticated.</p>';
                 return;
            }
            fetchData('teachers', teachers => {
                if (teachers.length === 0) {
                    displayDiv.innerHTML = '<p class="text-gray-500">No faculty members added. Add them via "Add/Remove Data" tool.</p>';
                    return;
                }
                 teachers.sort((a,b) => (a.initials || "").localeCompare(b.initials || ""));
                let tableHTML = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Initials</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">`;
                teachers.forEach(t => {
                    tableHTML += `<tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${t.initials}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${t.name}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${t.type}</td>
                                  </tr>`;
                });
                tableHTML += `</tbody></table>`;
                displayDiv.innerHTML = tableHTML;
            });
        }
        function loadAndDisplayCourseOfferingsForView() {
            const displayDiv = document.getElementById('courseOfferingsDisplay');
            displayDiv.innerHTML = '<p class="text-gray-500">Loading course offerings...</p>';
             if (!currentUserId || !allCoursesCache || !allCourseOfferingsCache) {
                 displayDiv.innerHTML = '<p class="text-gray-500">Data not available or not authenticated.</p>';
                 return;
            }
            
            if (allCourseOfferingsCache.length === 0) {
                 displayDiv.innerHTML = '<p class="text-gray-500">No course offerings defined. Add them via "Add/Remove Data" tool.</p>';
                 return;
            }
            allCourseOfferingsCache.sort((a,b) => (a.semester || "").localeCompare(b.semester || ""));

            let html = '';
            allCourseOfferingsCache.forEach(offering => {
                html += `<div class="mb-6"><h3 class="text-xl font-semibold text-red-600 mb-3">Semester: ${offering.semester}</h3>`;
                html += `<ul class="list-disc pl-5 space-y-1 text-sm">`;
                if (offering.courseIds && offering.courseIds.length > 0) {
                    offering.courseIds.forEach(courseId => {
                        const course = allCoursesCache.find(c => c.id === courseId);
                        const teacher = course ? allTeachersCache.find(t => t.id === course.defaultFacultyId) : null;
                        html += `<li><strong>${course ? course.code : 'N/A'}</strong> - ${course ? course.name : 'Unknown Course'} (Faculty: ${teacher ? teacher.initials : 'N/A'}, Room: ${course ? course.defaultRoom : 'N/A'})</li>`;
                    });
                } else {
                    html += `<li>No courses in this offering.</li>`;
                }
                html += `</ul></div>`;
            });
            displayDiv.innerHTML = html;
        }
        function loadAndDisplayHolidaysEvents() {
             const displayDiv = document.getElementById('holidaysEventsDisplay');
             displayDiv.innerHTML = '<p class="text-gray-500">Loading events and holidays...</p>';
              if (!currentUserId) {
                 displayDiv.innerHTML = '<p class="text-gray-500">Not authenticated.</p>';
                 return;
            }
            fetchData('events', events => {
                if (events.length === 0) {
                    displayDiv.innerHTML = '<p class="text-gray-500">No events or holidays recorded. Add them via "Add/Remove Data" tool.</p>';
                    return;
                }
                events.sort((a,b) => (a.startDate || "").localeCompare(b.startDate || "") || (a.name || "").localeCompare(b.name || ""));
                let html = '<ul class="space-y-3">';
                events.forEach(event => {
                    let dateRange = event.startDate;
                    if (event.endDate && event.endDate !== event.startDate) dateRange += ` to ${event.endDate}`;
                    if(event.startTime) dateRange += ` (${event.startTime}${event.endTime ? ' - ' + event.endTime : ''})`;
                    
                    html += `<li class="p-3 bg-gray-50 border border-gray-200 rounded-md">
                                <strong class="text-red-600">${event.type}:</strong> ${event.name}<br>
                                <small class="text-gray-600">Date(s): ${dateRange}</small>
                             </li>`;
                });
                html += '</ul>';
                displayDiv.innerHTML = html;
            });
        }
        function loadAndDisplayAcademicCalendar() {
            // This would typically be a more structured display, perhaps a monthly calendar view.
            // For now, it will be similar to holidays/events list but could be expanded.
            const displayDiv = document.getElementById('academicCalendarDisplay');
            displayDiv.innerHTML = '<p class="text-gray-500">Academic Calendar events (e.g., semester start/end, exams) will be shown here. Currently displays all events.</p>';
            loadAndDisplayHolidaysEvents(); // Re-use the same display for now
        }

        // --- Course Outline Generator (using Gemini API) ---
        const outlineCourseSelect = document.getElementById('outlineCourseSelect');
        const customPromptInput = document.getElementById('customPrompt');
        const generateOutlineBtn = document.getElementById('generateOutlineBtn');
        const courseOutlineResultDiv = document.getElementById('courseOutlineResult');
        const outlineContentDiv = document.getElementById('outlineContent');
        const outlineActionButtons = document.getElementById('outlineActionButtons');

        generateOutlineBtn.addEventListener('click', async () => {
            const selectedCourseId = outlineCourseSelect.value;
            if (!selectedCourseId) {
                showMessage("Please select a course.", true);
                return;
            }
            const course = allCoursesCache.find(c => c.id === selectedCourseId);
            if (!course) {
                showMessage("Selected course not found.", true);
                return;
            }

            showLoading(true);
            courseOutlineResultDiv.classList.add('hidden');
            outlineContentDiv.innerHTML = '<p class="text-center">Generating course outline...</p>';
            
            let prompt = `Generate a comprehensive 12-week undergraduate course outline for "${course.name}" (Course Code: ${course.code}, Credits: ${course.credit}). The course is part of a ${course.curriculumType} program. Key learning objectives should be clearly stated. Include weekly topics, suggested readings (if any, placeholder names are fine), and assessment methods (e.g., mid-term, final exam, assignments, presentation). The target students are in the ${course.offeredToSemester} of their program.`;

            const customInstructions = customPromptInput.value.trim();
            if (customInstructions) {
                prompt += `\n\nAdditional instructions from user: ${customInstructions}`;
            }
             prompt += `\n\nFormat the output clearly with headings for each section (e.g., Course Description, Learning Objectives, Weekly Breakdown, Assessment). Use Markdown for formatting.`;


            try {
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = ""; // Will be auto-filled by Canvas if using gemini-2.0-flash or imagen-3.0-generate-002
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorResult = await response.json();
                    throw new Error(`API Error (${response.status}): ${errorResult.error?.message || 'Unknown error'}`);
                }
                
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    let generatedText = result.candidates[0].content.parts[0].text;
                    
                    // Basic Markdown to HTML conversion (very simplified)
                    generatedText = generatedText
                        .replace(/^### (.*$)/gim, '<h3 class="text-lg font-semibold mt-2 mb-1">$1</h3>')
                        .replace(/^## (.*$)/gim, '<h2 class="text-xl font-bold mt-3 mb-2">$1</h2>')
                        .replace(/^# (.*$)/gim, '<h1 class="text-2xl font-extrabold mt-4 mb-3">$1</h1>')
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
                        .replace(/\*(.*?)\*/g, '<em>$1</em>')       // Italics
                        .replace(/^- (.*$)/gim, '<li class="ml-4">$1</li>') // List items
                        .replace(/\n/g, '<br>'); // Newlines
                    // Wrap list items in <ul> - this needs more robust parsing for proper HTML lists
                    generatedText = generatedText.replace(/(<li.*<\/li>)(?!<ul)/gim, '<ul>$1</ul>').replace(/<\/ul><br><ul>/gim, '');


                    outlineContentDiv.innerHTML = generatedText;
                    courseOutlineResultDiv.classList.remove('hidden');
                    outlineActionButtons.classList.remove('hidden');
                } else {
                    throw new Error("No content received from API or unexpected response structure.");
                }

            } catch (error) {
                console.error("Error generating course outline:", error);
                outlineContentDiv.innerHTML = `<p class="text-red-500">Error generating outline: ${error.message}. Please check console for details.</p>`;
                 courseOutlineResultDiv.classList.remove('hidden');
                 outlineActionButtons.classList.add('hidden');
            } finally {
                showLoading(false);
            }
        });


        // --- Print and PDF Download ---
        window.printContent = function(elementId, title = 'Document') {
            const printContent = document.getElementById(elementId);
            if (!printContent) {
                showMessage('Content to print not found.', true);
                return;
            }
            const originalTitle = document.title;
            document.title = title;
            
            // Clone the content to avoid modifying the original
            const contentToPrint = printContent.cloneNode(true);
            
            // Create a temporary iframe to print
            const iframe = document.createElement('iframe');
            iframe.style.height = '0';
            iframe.style.width = '0';
            iframe.style.position = 'absolute';
            iframe.style.top = '-9999px';
            document.body.appendChild(iframe);

            iframe.contentDocument.head.innerHTML = `
                <title>${title}</title>
                <link rel="stylesheet" href="https://cdn.tailwindcss.com"> <style>
                    body { font-family: 'Times New Roman', Times, serif; margin: 20mm; font-size: 10pt; color: #000; }
                    table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 9pt; }
                    th, td { border: 1px solid #000; padding: 5px; text-align: left; }
                    th { background-color: #f0f0f0; font-weight: bold; }
                    tr:nth-child(even) { background-color: #f9f9f9; }
                    .print-header, .print-footer { display: block !important; } /* Ensure these are visible for print */
                    .actions-cell, .delete-btn, form, .btn-primary, .btn-secondary, .tab-buttons, .nav-menu-item, #loginSection, #loadingIndicator, .clash-report { display: none !important; }
                    /* Add any other print-specific styles from your main CSS here */
                     .routine-grid { min-width: unset; width: 100%; }
                     .routine-grid th, .routine-grid td { height: auto; vertical-align: middle; font-size: 8pt; padding: 3px;}
                     .routine-item { background-color: #e0e0e0 !important; color: #000 !important; border: 1px solid #ccc !important; box-shadow: none !important; margin-bottom: 2px; padding: 2px 5px; font-size: 7pt;}
                     .routine-grid td.time-slot-header { background-color: #f0f0f0; font-weight: bold;}
                     .prose { font-size: 10pt; } /* For course outline */
                     .prose h1 { font-size: 16pt; }
                     .prose h2 { font-size: 14pt; }
                     .prose h3 { font-size: 12pt; }
                </style>
            `;
            iframe.contentDocument.body.innerHTML = contentToPrint.innerHTML;
            
            // Remove action columns/buttons from the cloned content if they exist
            const actionsCells = iframe.contentDocument.querySelectorAll('.actions-cell, .delete-btn');
            actionsCells.forEach(cell => cell.remove());


            setTimeout(() => { // Timeout to ensure content is loaded in iframe
                iframe.contentWindow.focus();
                iframe.contentWindow.print();
                document.body.removeChild(iframe);
                document.title = originalTitle;
            }, 500);
        }

        window.downloadContentAsPdf = async function(elementId, fileName = 'document.pdf') {
            const { jsPDF } = window.jspdf;
            const contentToDownload = document.getElementById(elementId);

            if (!contentToDownload) {
                showMessage('Content to download not found.', true);
                return;
            }
            showLoading(true);

            // Temporarily remove action buttons/columns for PDF generation
            const clonedContent = contentToDownload.cloneNode(true);
            clonedContent.querySelectorAll('.actions-cell, .delete-btn, form, .btn-primary, .btn-secondary, .tab-buttons').forEach(el => el.style.display = 'none');
            
            // Add a temporary container for html2canvas if the element itself is not suitable (e.g. overflow issues)
            const tempContainer = document.createElement('div');
            tempContainer.style.position = 'absolute';
            tempContainer.style.left = '-9999px'; // Off-screen
            tempContainer.style.width = contentToDownload.scrollWidth + 'px'; // Use scrollWidth for full content
            tempContainer.appendChild(clonedContent);
            document.body.appendChild(tempContainer);


            try {
                const canvas = await html2canvas(tempContainer, {
                    scale: 2, // Increase scale for better quality
                    useCORS: true, // If you have external images
                    logging: true,
                    onclone: (doc) => { // Apply print styles to the cloned document for html2canvas
                        const style = doc.createElement('style');
                        style.innerHTML = `
                            body { font-family: 'Times New Roman', Times, serif; font-size: 10pt; color: #000; }
                            table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 9pt; }
                            th, td { border: 1px solid #000; padding: 5px; text-align: left; }
                            th { background-color: #f0f0f0; font-weight: bold; }
                            .actions-cell, .delete-btn { display: none !important; }
                            .routine-grid { min-width: unset; width: 100%; }
                            .routine-grid th, .routine-grid td { height: auto; vertical-align: middle; font-size: 8pt; padding: 3px;}
                            .routine-item { background-color: #e0e0e0 !important; color: #000 !important; border: 1px solid #ccc !important; box-shadow: none !important; margin-bottom: 2px; padding: 2px 5px; font-size: 7pt;}
                            .routine-grid td.time-slot-header { background-color: #f0f0f0; font-weight: bold;}
                            .prose { font-size: 10pt; }
                            .prose h1 { font-size: 16pt; }
                            .prose h2 { font-size: 14pt; }
                            .prose h3 { font-size: 12pt; }
                        `;
                        doc.head.appendChild(style);
                    }
                });
                
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({
                    orientation: 'p', // portrait
                    unit: 'mm',
                    format: 'a4'
                });

                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const imgWidth = imgProps.width;
                const imgHeight = imgProps.height;

                // Calculate aspect ratio
                const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
                const newImgWidth = imgWidth * ratio;
                const newImgHeight = imgHeight * ratio;
                
                let position = 0;
                let heightLeft = newImgHeight;
                const pageMargin = 10; // mm

                // If content is taller than one page, split it
                if (newImgHeight > pdfHeight - 2 * pageMargin) {
                     const pageHeight = pdfHeight - 2 * pageMargin;
                     let numPages = Math.ceil(newImgHeight / pageHeight);

                    for (let i = 0; i < numPages; i++) {
                        let sourceY = i * (imgHeight / numPages); // Y position in original canvas pixels
                        let sourceHeight = (imgHeight / numPages);
                        
                        // Create a temporary canvas for the current page segment
                        const tempPageCanvas = document.createElement('canvas');
                        tempPageCanvas.width = imgWidth;
                        tempPageCanvas.height = sourceHeight;
                        const tempCtx = tempPageCanvas.getContext('2d');
                        tempCtx.drawImage(canvas, 0, sourceY, imgWidth, sourceHeight, 0, 0, imgWidth, sourceHeight);
                        const pageImgData = tempPageCanvas.toDataURL('image/png');

                        if (i > 0) pdf.addPage();
                        pdf.addImage(pageImgData, 'PNG', pageMargin, pageMargin, newImgWidth - (pageMargin*0.2) , pageHeight - (pageMargin*0.2)); // Adjust width/height slightly if needed
                    }

                } else {
                     pdf.addImage(imgData, 'PNG', pageMargin, pageMargin, newImgWidth - pageMargin, newImgHeight - pageMargin);
                }
                
                pdf.save(fileName);

            } catch (error) {
                console.error("Error generating PDF: ", error);
                showMessage('Error generating PDF. Check console.', true);
            } finally {
                document.body.removeChild(tempContainer); // Clean up temporary container
                showLoading(false);
            }
        }


        // --- Initial Load and Setup ---
        // This will be triggered by onAuthStateChanged after successful authentication
        // setActiveSection('homeSection'); // Set initial section (now handled in onAuthStateChanged)

    </script>
</body>
</html>
